<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Morrow Industries — Family Payment Tracker</title>
  <link rel="icon" href="/morIcon.png" />
  <link rel="stylesheet" href="/assets/css/family-tracker.css" />
  <script src="https://cdn.tailwindcss.com"></script>
  <script type="module" src="/assets/js/firebase-init.js"></script>
</head>

<body class="min-h-screen flex flex-col bg-gradient-to-b from-black to-[#0a0b0f] text-[#e9eef8] font-[Inter] p-6">
  <!-- Header -->
  <header class="flex justify-between items-center mb-6">
    <div class="flex items-center gap-3">
      <img src="/morIcon.png" alt="logo" class="h-8 w-8" />
      <h1 class="text-2xl font-semibold text-[#d4af37]">Family Payment Tracker</h1>
    </div>
    <button id="logoutBtn" class="bg-[#d4af37] text-black font-semibold rounded-md px-3 py-1 hover:opacity-80 transition">Sign Out</button>
  </header>

  <!-- Summary Section -->
  <section id="summary" class="grid sm:grid-cols-2 lg:grid-cols-4 gap-4 mb-8">
    <div class="summary-card">
      <h3>Total Balance</h3>
      <p id="totalBalance" class="card-value">$0.00</p>
    </div>
    <div class="summary-card">
      <h3>Next Due Date</h3>
      <p id="nextDueDate" class="card-value">—</p>
    </div>
    <div class="summary-card">
      <h3>Next Amount Due</h3>
      <p id="nextAmountDue" class="card-value">$0.00</p>
    </div>
    <div class="summary-card">
      <h3>Active Loans</h3>
      <p id="activeLoans" class="card-value">0</p>
    </div>
  </section>

  <!-- Loan List -->
  <main>
    <h2 class="text-xl font-semibold text-[#d4af37] mb-3">Your Loans</h2>
    <div id="loanContainer" class="space-y-4">
      <div id="loading" class="text-center italic text-[#d4af37]">Loading your loans...</div>
    </div>
  </main>

  <!-- Overlay for modals (kept for consistency) -->
  <div id="overlay" class="overlay hidden"></div>

  <!-- Logic (Part 2 below) -->
<script type="module">
import {
  auth,
  db,
  GoogleAuthProvider,
  signInWithPopup,
  onAuthStateChanged,
  signOut,
  doc,
  getDoc,
  collection,
  onSnapshot
} from "/assets/js/firebase-init.js";

/* ─────────── UI References ─────────── */
const logoutBtn = document.getElementById("logoutBtn");
const loanContainer = document.getElementById("loanContainer");
const loadingEl = document.getElementById("loading");

/* Summary Elements */
const totalBalanceEl = document.getElementById("totalBalance");
const nextDueDateEl = document.getElementById("nextDueDate");
const nextAmountDueEl = document.getElementById("nextAmountDue");
const activeLoansEl = document.getElementById("activeLoans");

/* ─────────── Authentication ─────────── */
logoutBtn.onclick = () => signOut(auth).then(() => (window.location.href = "index.html"));

onAuthStateChanged(auth, async (user) => {
  if (!user) {
    const provider = new GoogleAuthProvider();
    await signInWithPopup(auth, provider);
    return;
  }

  const userDoc = await getDoc(doc(db, "users", user.uid));
  if (!userDoc.exists() || userDoc.data().role_familyTracker !== "viewer") {
    window.location = "unauthorized.html";
    return;
  }

  watchLoans(user.uid);
});

/* ─────────── Watch Loans ─────────── */
function watchLoans(uid) {
  const ref = collection(db, "loans", uid, "userLoans");
  onSnapshot(ref, (snap) => {
    loanContainer.innerHTML = "";
    if (snap.empty) {
      const msg = document.createElement("div");
      msg.className = "glass p-6 text-center";
      msg.innerHTML = `
        <h2 class="text-lg font-semibold text-[#d4af37] mb-2">No Loans Found</h2>
        <p class="text-sm text-gray-300">It looks like you don't have any active loans yet.</p>`;
      loanContainer.appendChild(msg);
      updateSummary(0, [], 0);
      return;
    }

    let totalBal = 0;
    let allFuture = [];
    snap.forEach((docSnap) => {
      const loan = docSnap.data();
      renderLoan(loan);
      const bal = calcBalance(loan);
      totalBal += bal.remaining;
      if (loan.futurePayments) allFuture.push(...loan.futurePayments);
    });
    updateSummary(totalBal, allFuture, snap.size);
  });
}

/* ─────────── Dashboard Summary ─────────── */
function updateSummary(total, futures, count) {
  totalBalanceEl.textContent = `$${total.toFixed(2)}`;
  activeLoansEl.textContent = count;
  if (futures.length) {
    futures.sort((a, b) => new Date(a.dueDate) - new Date(b.dueDate));
    const next = futures[0];
    nextDueDateEl.textContent = new Date(next.dueDate).toLocaleDateString();
    nextAmountDueEl.textContent = `$${next.amount.toFixed(2)}`;
  } else {
    nextDueDateEl.textContent = "—";
    nextAmountDueEl.textContent = "$0.00";
  }
}

/* ─────────── Render Loan Cards ─────────── */
function renderLoan(loan) {
  const { loanName, totalAmount = 0, loanIcon = "/assets/icons/default-loan.png" } = loan;
  const bal = calcBalance(loan);
  const percent = totalAmount ? (bal.paid / totalAmount) * 100 : 0;

  const card = document.createElement("div");
  card.className = "glass rounded-lg p-4 transition transform hover:-translate-y-1 hover:shadow-lg";
  card.innerHTML = `
    <div class="flex justify-between items-center cursor-pointer" data-expand="${loanName}">
      <div class="flex items-center gap-3">
        <img src="${loanIcon}" class="w-12 h-12 rounded-md object-cover border border-[rgba(255,255,255,0.1)]" />
        <div>
          <h3 class="text-[#d4af37] font-semibold">${loanName}</h3>
          <p class="text-sm text-gray-300">Remaining: $${bal.remaining.toFixed(2)}</p>
        </div>
      </div>
      <div class="text-right">
        <p class="text-sm text-gray-400">Next Due</p>
        <p class="text-sm">${bal.nextDue || "—"}</p>
      </div>
    </div>
    <div class="w-full h-2 bg-[rgba(255,255,255,0.1)] rounded mt-3">
      <div class="h-2 bg-[#d4af37] rounded" style="width:${percent}%"></div>
    </div>
    <div id="details-${loanName}" class="hidden mt-4">
      ${renderLoanDetails(loan, bal)}
    </div>`;
  card.querySelector(`[data-expand="${loanName}"]`).onclick = () => toggleDetails(loanName);
  loanContainer.appendChild(card);
}

/* ─────────── Balance & Details ─────────── */
function calcBalance(loan) {
  const payments = loan.transactions || [];
  const totalPaid = payments.reduce((a, t) => a + t.amount, 0);
  const future = loan.futurePayments || [];
  const remaining = (loan.totalAmount || 0) - totalPaid;
  const nextDue = future.length ? future.sort((a, b) => new Date(a.dueDate) - new Date(b.dueDate))[0].dueDate : null;
  return { paid: totalPaid, remaining, nextDue };
}

function renderLoanDetails(loan, bal) {
  const payments = loan.transactions || [];
  const futures = loan.futurePayments || [];
  let running = loan.totalAmount || 0;

  const rows = payments
    .map((p) => {
      running -= p.amount;
      const d = p.date?.toDate?.() || new Date(p.date);
      return `<tr><td>${d.toLocaleDateString()}</td><td>$${p.amount.toFixed(2)}</td><td>${p.note || ""}</td><td>$${running.toFixed(2)}</td></tr>`;
    })
    .join("");

  const futRows = futures
    .map((f) => `<tr><td>${new Date(f.dueDate).toLocaleDateString()}</td><td>$${f.amount.toFixed(2)}</td></tr>`)
    .join("");

  return `
  <div class="glass p-3 rounded mt-3">
    <p class="text-sm mb-2">Total: $${loan.totalAmount?.toFixed(2) || 0}</p>
    <p class="text-sm mb-4">Remaining: <span class="text-[#d4af37]">$${bal.remaining.toFixed(2)}</span></p>
    <h4 class="font-semibold text-[#d4af37] mb-1">Payment History</h4>
    <table class="text-sm w-full mb-4 border-t border-[rgba(255,255,255,0.1)]">
      <tr class="text-[#d4af37]"><th>Date</th><th>Amount</th><th>Note</th><th>Remaining</th></tr>
      ${rows || "<tr><td colspan='4' class='text-center py-1 text-xs'>No payments yet</td></tr>"}
    </table>
    <h4 class="font-semibold text-[#d4af37] mb-1">Future Payments</h4>
    <table class="text-sm w-full border-t border-[rgba(255,255,255,0.1)]">
      <tr class="text-[#d4af37]"><th>Due Date</th><th>Amount</th></tr>
      ${futRows || "<tr><td colspan='2' class='text-center py-1 text-xs'>No future payments</td></tr>"}
    </table>
  </div>`;
}

function toggleDetails(id) {
  const d = document.getElementById(`details-${id}`);
  d.classList.toggle("hidden");
}
</script>
</body>
</html>