<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Morrow Industries — Family Payment Tracker (Admin)</title>
  <link rel="icon" href="/morIcon.png" />
  <link rel="stylesheet" href="/assets/css/family-tracker.css" />
  <script src="https://cdn.tailwindcss.com"></script>
  <script type="module" src="/assets/js/firebase-init.js"></script>
</head>

<body class="min-h-screen flex flex-col bg-gradient-to-b from-black to-[#0a0b0f] text-[#e9eef8] font-[Inter] p-6">
  <!-- Header -->
  <header class="flex justify-between items-center mb-6">
    <div class="flex items-center gap-3">
      <img src="/morIcon.png" alt="logo" class="h-8 w-8" />
      <h1 class="text-2xl font-semibold text-[#d4af37]">Family Payment Tracker — Admin</h1>
    </div>
    <button id="logoutBtn" class="bg-[#d4af37] text-black font-semibold rounded-md px-3 py-1 hover:opacity-80 transition">Sign Out</button>
  </header>

  <!-- Summary -->
  <section id="summary" class="grid sm:grid-cols-2 lg:grid-cols-4 gap-4 mb-8">
    <div class="summary-card"><h3>Total Balance</h3><p id="totalBalance" class="card-value">$0.00</p></div>
    <div class="summary-card"><h3>Next Due Date</h3><p id="nextDueDate" class="card-value">—</p></div>
    <div class="summary-card"><h3>Next Amount Due</h3><p id="nextAmountDue" class="card-value">$0.00</p></div>
    <div class="summary-card"><h3>Active Loans</h3><p id="activeLoans" class="card-value">0</p></div>
  </section>

  <!-- Panel -->
  <div id="adminPanel" class="grid md:grid-cols-3 gap-6">
    <!-- Users -->
    <div class="glass p-4">
      <h2 class="text-lg font-semibold mb-3 text-[#d4af37]">All Users</h2>
      <div id="userList" class="space-y-2 text-sm"></div>
    </div>

    <!-- Loans -->
    <div class="glass p-4 md:col-span-2">
      <h2 class="text-lg font-semibold mb-3 text-[#d4af37]">User Loans</h2>
      <div id="selectedUserInfo" class="mb-4 text-sm italic"></div>
      <div id="loanList" class="space-y-4"></div>
      <div class="flex justify-end">
        <button id="addLoanBtn" class="bg-[#d4af37] text-black font-semibold rounded-md px-4 py-1 hover:opacity-80 transition mt-4">+ Add Loan</button>
      </div>
    </div>
  </div>

  <!-- Add Loan Modal -->
  <div id="addLoanModal" class="modal hidden">
    <div class="modal-content glass p-6 w-[90%] max-w-lg">
      <h2 class="text-xl font-semibold text-[#d4af37] mb-4">Add New Loan</h2>
      <form id="addLoanForm" class="space-y-3">
        <div><label class="block text-sm mb-1">Loan Name</label>
          <input type="text" name="loanName" required class="form-input" placeholder="e.g. Camry Purchase" />
        </div>
        <div><label class="block text-sm mb-1">Total Amount</label>
          <input type="number" name="totalAmount" required class="form-input" placeholder="e.g. 12000" />
        </div>
        <div class="grid grid-cols-2 gap-3">
          <div><label class="block text-sm mb-1">Start Date</label><input type="date" name="startDate" class="form-input" /></div>
          <div><label class="block text-sm mb-1">First Payment Date</label><input type="date" name="firstPaymentDate" class="form-input" /></div>
        </div>
        <div><label class="block text-sm mb-1">Payment Frequency</label>
          <select name="paymentFrequency" class="form-input">
            <option value="monthly">Monthly</option>
            <option value="biweekly">Biweekly</option>
            <option value="weekly">Weekly</option>
          </select>
        </div>
        <div><label class="block text-sm mb-1">Loan Icon</label>
          <input type="file" id="loanIconInput" accept="image/*" class="form-input" />
          <img id="loanIconPreview" src="/assets/icons/default-loan.png" class="w-16 h-16 mt-2 rounded-md object-cover border border-[rgba(255,255,255,0.1)]" />
        </div>
        <div class="flex justify-end gap-2 pt-4">
          <button type="button" id="cancelAddLoan" class="btn-secondary">Cancel</button>
          <button type="submit" class="btn-primary">Save Loan</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Upload Icon Modal -->
  <div id="iconUploadModal" class="modal hidden">
    <div class="modal-content glass p-6 w-[90%] max-w-md text-center">
      <h2 class="text-xl font-semibold text-[#d4af37] mb-4">Change Loan Icon</h2>
      <img id="iconPreview" src="/assets/icons/default-loan.png" class="w-24 h-24 mx-auto rounded-md border border-[rgba(255,255,255,0.1)] object-cover mb-4" />
      <input type="file" id="iconFileInput" accept="image/*" class="form-input mb-4" />
      <div class="flex justify-center gap-3">
        <button id="cancelIconUpload" class="btn-secondary">Cancel</button>
        <button id="confirmIconUpload" class="btn-primary">Upload</button>
      </div>
    </div>
  </div>

  <!-- Full-Screen Loan Details Modal -->
  <div id="loanDetailsModal" class="fixed inset-0 hidden flex flex-col justify-end bg-black/80 backdrop-blur-xl z-50 transition-transform duration-300 ease-out">
    <div class="glass w-full max-h-[90vh] rounded-t-2xl overflow-y-auto p-6 transform translate-y-full transition-all duration-300" id="loanDetailsCard">
      <!-- Header -->
      <div class="flex justify-between items-center mb-4">
        <div class="flex items-center gap-3">
          <img id="detailsIcon" src="/assets/icons/default-loan.png" class="w-12 h-12 rounded-md border border-[rgba(255,255,255,0.1)] object-cover" />
          <h2 id="detailsName" class="text-xl font-semibold text-[#d4af37]">Loan Title</h2>
        </div>
        <button id="closeLoanDetails" class="text-gray-400 hover:text-[#d4af37] text-xl font-bold">✕</button>
      </div>

      <!-- Loan Stats -->
      <div id="detailsStats" class="mb-4 grid sm:grid-cols-2 lg:grid-cols-4 gap-3 text-sm">
        <div class="glass p-3 text-center"><p>Total</p><p id="detailsTotal" class="text-[#d4af37] font-semibold">$0.00</p></div>
        <div class="glass p-3 text-center"><p>Paid</p><p id="detailsPaid" class="text-[#d4af37] font-semibold">$0.00</p></div>
        <div class="glass p-3 text-center"><p>Remaining</p><p id="detailsRemaining" class="text-[#d4af37] font-semibold">$0.00</p></div>
        <div class="glass p-3 text-center"><p>Next Due</p><p id="detailsNextDue" class="text-[#d4af37] font-semibold">—</p></div>
      </div>

      <!-- Edit Mode Trigger -->
      <div class="flex justify-end mb-2">
        <button id="editLoanBtn" class="btn-primary">Edit Loan</button>
      </div>

      <!-- Edit Section (hidden until edit mode) -->
      <div id="editSection" class="hidden slide-up space-y-3 mb-4">
        <input id="editLoanName" class="form-input" placeholder="Loan Name" />
        <input id="editTotalAmount" type="number" class="form-input" placeholder="Total Amount" />
        <select id="editFrequency" class="form-input">
          <option value="monthly">Monthly</option>
          <option value="biweekly">Biweekly</option>
          <option value="weekly">Weekly</option>
        </select>
        <div class="flex justify-between mt-3">
          <button id="cancelEditBtn" class="btn-secondary">Cancel</button>
          <div class="flex gap-2">
            <button id="saveEditBtn" class="btn-primary">Save</button>
            <button id="deleteLoanBtn" class="bg-red-600 text-white rounded-md px-3 py-1 hover:opacity-80">Delete</button>
          </div>
        </div>
      </div>

      <!-- Payment Lists -->
      <div id="loanPayments" class="space-y-6">
        <div>
          <h3 class="text-[#d4af37] font-semibold mb-2">Payment History</h3>
          <table id="detailsHistory" class="text-sm w-full border-t border-[rgba(255,255,255,0.1)]"></table>
        </div>
        <div>
          <h3 class="text-[#d4af37] font-semibold mb-2">Upcoming Payments</h3>
          <table id="detailsUpcoming" class="text-sm w-full border-t border-[rgba(255,255,255,0.1)]"></table>
        </div>
      </div>

      <!-- Add Payment (in Edit Mode) -->
      <div id="addPaymentSection" class="hidden mt-6">
        <h3 class="text-[#d4af37] font-semibold mb-2">Add Payment</h3>
        <form id="addPaymentForm" class="flex flex-wrap gap-2 text-sm">
          <input id="paymentAmount" type="number" step="0.01" placeholder="Amount" class="form-input w-28" required />
          <input id="paymentNote" type="text" placeholder="Note" class="form-input flex-1" />
          <button type="submit" class="btn-primary">Add</button>
        </form>
      </div>
    </div>
  </div>

  <!-- Delete Confirmation Modals -->
  <!-- Passcode -->
  <div id="passcodeModal" class="modal hidden">
    <div class="modal-content glass p-6 w-[90%] max-w-sm text-center">
      <h2 class="text-lg font-semibold text-[#d4af37] mb-2">Enter Admin Passcode</h2>
      <input id="adminPassInput" type="password" placeholder="••••••" class="form-input text-center mb-4" />
      <div class="flex justify-center gap-3">
        <button id="cancelPasscode" class="btn-secondary">Cancel</button>
        <button id="verifyPasscode" class="btn-primary">Verify</button>
      </div>
    </div>
  </div>

  <!-- Override -->
  <div id="overrideModal" class="modal hidden">
    <div class="modal-content glass p-6 w-[90%] max-w-sm text-center">
      <h2 class="text-lg font-semibold text-[#d4af37] mb-3">Admin Override Required</h2>
      <p class="text-sm text-gray-300 mb-4">Confirm you are an authorized admin to proceed.</p>
      <div class="flex justify-center gap-3">
        <button id="cancelOverride" class="btn-secondary">Cancel</button>
        <button id="confirmOverride" class="btn-primary">Confirm</button>
      </div>
    </div>
  </div>

  <!-- Name Match -->
  <div id="nameMatchModal" class="modal hidden">
    <div class="modal-content glass p-6 w-[90%] max-w-sm text-center">
      <h2 class="text-lg font-semibold text-[#d4af37] mb-3">Final Confirmation</h2>
      <p class="text-sm text-gray-300 mb-2">Type the loan name exactly to confirm deletion.</p>
      <input id="confirmLoanNameInput" type="text" class="form-input text-center mb-4" placeholder="Exact Loan Name" />
      <div class="flex justify-center gap-3">
        <button id="cancelNameMatch" class="btn-secondary">Cancel</button>
        <button id="finalDeleteBtn" class="bg-red-600 text-white rounded-md px-3 py-1 hover:opacity-80">Delete</button>
      </div>
    </div>
  </div>

  <!-- Overlay -->
  <div id="overlay" class="overlay hidden"></div>

  <!-- JS Logic will follow -->
<script type="module">
import {
  auth, db,
  GoogleAuthProvider, signInWithPopup, onAuthStateChanged, signOut,
  collection, doc, getDoc, getDocs, onSnapshot, addDoc, updateDoc, deleteDoc
} from "/assets/js/firebase-init.js";

/* ───────────── GLOBAL ELEMENTS ───────────── */
const userListEl = document.getElementById("userList");
const loanListEl = document.getElementById("loanList");
const logoutBtn = document.getElementById("logoutBtn");
const selectedUserInfo = document.getElementById("selectedUserInfo");

/* Modals & Buttons */
const loanDetailsModal = document.getElementById("loanDetailsModal");
const loanDetailsCard  = document.getElementById("loanDetailsCard");
const closeLoanDetails = document.getElementById("closeLoanDetails");
const editLoanBtn      = document.getElementById("editLoanBtn");
const editSection      = document.getElementById("editSection");
const cancelEditBtn    = document.getElementById("cancelEditBtn");
const saveEditBtn      = document.getElementById("saveEditBtn");
const deleteLoanBtn    = document.getElementById("deleteLoanBtn");
const addPaymentSection= document.getElementById("addPaymentSection");
const addPaymentForm   = document.getElementById("addPaymentForm");

/* Delete sequence modals */
const passcodeModal    = document.getElementById("passcodeModal");
const overrideModal    = document.getElementById("overrideModal");
const nameMatchModal   = document.getElementById("nameMatchModal");
const adminPassInput   = document.getElementById("adminPassInput");
const verifyPasscode   = document.getElementById("verifyPasscode");
const confirmOverride  = document.getElementById("confirmOverride");
const finalDeleteBtn   = document.getElementById("finalDeleteBtn");
const confirmLoanNameInput = document.getElementById("confirmLoanNameInput");

/* Summary */
const totalBalanceEl   = document.getElementById("totalBalance");
const nextDueDateEl    = document.getElementById("nextDueDate");
const nextAmountDueEl  = document.getElementById("nextAmountDue");
const activeLoansEl    = document.getElementById("activeLoans");

let selectedUser = null;
let currentLoan  = null;
let verifiedPass = false;

/* ───────────── AUTHENTICATION ───────────── */
logoutBtn.onclick = () => signOut(auth);

onAuthStateChanged(auth, async user => {
  if (!user) {
    await signInWithPopup(auth,new GoogleAuthProvider());
    return;
  }
  const u = await getDoc(doc(db,"users",user.uid));
  if (!u.exists() || u.data().role_familyTracker!=="admin"){
    window.location="unauthorized.html"; return;
  }
  loadUsers();
});

/* ───────────── LOAD USERS ───────────── */
async function loadUsers(){
  userListEl.innerHTML="";
  const users=await getDocs(collection(db,"users"));
  users.forEach(u=>{
    const data=u.data();
    const row=document.createElement("div");
    row.className="p-2 rounded hover:bg-[var(--border)] cursor-pointer";
    row.innerHTML=`
      <div class="flex justify-between items-center">
        <span>${data.name||data.email}</span>
        <select data-uid="${u.id}" class="bg-transparent border border-[var(--border)] rounded px-1 text-xs">
          <option value="">none</option>
          <option value="admin" ${data.role_familyTracker==="admin"?"selected":""}>admin</option>
          <option value="viewer" ${data.role_familyTracker==="viewer"?"selected":""}>viewer</option>
        </select>
      </div>`;
    row.querySelector("select").onchange=e=>updateUserRole(u.id,e.target.value);
    row.onclick=()=>selectUser(u.id,data);
    userListEl.appendChild(row);
  });
}
async function updateUserRole(uid,role){
  await updateDoc(doc(db,"users",uid),{role_familyTracker:role||null});
}

/* ───────────── SELECT USER ───────────── */
function selectUser(uid,data){
  selectedUser=uid;
  selectedUserInfo.textContent=`Managing loans for: ${data.name||data.email}`;
  watchLoans(uid);
}

/* ───────────── WATCH LOANS ───────────── */
function watchLoans(uid){
  loanListEl.innerHTML="";
  const ref=collection(db,"loans",uid,"userLoans");
  onSnapshot(ref,snap=>{
    loanListEl.innerHTML="";
    if(snap.empty){
      loanListEl.innerHTML=`<p class="text-center text-gray-400 italic p-4">No loans yet</p>`;
      updateSummary(0,[],0);
      return;
    }
    let total=0, future=[];
    snap.forEach(d=>{
      const loan=d.data(); loan.id=d.id;
      total+=calcBalance(loan).remaining;
      if(loan.futurePayments) future.push(...loan.futurePayments);
      renderLoanCard(uid,loan);
    });
    updateSummary(total,future,snap.size);
  });
}

/* ───────────── DASHBOARD SUMMARY ───────────── */
function updateSummary(total,futures,count){
  totalBalanceEl.textContent=`$${total.toFixed(2)}`;
  activeLoansEl.textContent=count;
  if(futures.length){
    futures.sort((a,b)=>new Date(a.dueDate)-new Date(b.dueDate));
    const n=futures[0];
    nextDueDateEl.textContent=new Date(n.dueDate).toLocaleDateString();
    nextAmountDueEl.textContent=`$${n.amount.toFixed(2)}`;
  }else{
    nextDueDateEl.textContent="—"; nextAmountDueEl.textContent="$0.00";
  }
}

/* ───────────── RENDER LOAN CARD ───────────── */
function renderLoanCard(uid,loan){
  const bal=calcBalance(loan);
  const percent=(loan.totalAmount?(bal.paid/loan.totalAmount)*100:0);
  const card=document.createElement("div");
  card.className="glass p-4 rounded-md cursor-pointer hover:shadow-lg transition";
  card.innerHTML=`
    <div class="flex justify-between items-center">
      <div class="flex items-center gap-3">
        <img src="${loan.loanIcon||"/assets/icons/default-loan.png"}" class="w-12 h-12 rounded-md border border-[rgba(255,255,255,0.1)]"/>
        <div>
          <h3 class="text-[#d4af37] font-semibold">${loan.loanName}</h3>
          <p class="text-sm text-gray-400">Remaining $${bal.remaining.toFixed(2)}</p>
        </div>
      </div>
      <div class="text-right text-sm">
        <p class="text-gray-400">Next</p>
        <p>${bal.nextDue||"—"}</p>
      </div>
    </div>
    <div class="h-2 bg-[rgba(255,255,255,0.1)] rounded mt-3">
      <div class="h-2 bg-[#d4af37] rounded" style="width:${percent}%"></div>
    </div>`;
  card.onclick=()=>openLoanModal(uid,loan);
  loanListEl.appendChild(card);
}

/* ───────────── LOAN MODAL HANDLING ───────────── */
function openLoanModal(uid,loan){
  currentLoan={uid,id:loan.id,data:loan};
  fillLoanDetails(loan);
  loanDetailsModal.classList.remove("hidden");
  setTimeout(()=>loanDetailsCard.classList.remove("translate-y-full"),10);
}
closeLoanDetails.onclick=()=>closeModal();
function closeModal(){
  loanDetailsCard.classList.add("translate-y-full");
  setTimeout(()=>loanDetailsModal.classList.add("hidden"),250);
  editSection.classList.add("hidden");
  addPaymentSection.classList.add("hidden");
}

/* ───────────── FILL DETAILS ───────────── */
function fillLoanDetails(loan){
  document.getElementById("detailsIcon").src=loan.loanIcon||"/assets/icons/default-loan.png";
  document.getElementById("detailsName").textContent=loan.loanName;
  const bal=calcBalance(loan);
  document.getElementById("detailsTotal").textContent=`$${loan.totalAmount?.toFixed(2)||0}`;
  document.getElementById("detailsPaid").textContent=`$${bal.paid.toFixed(2)}`;
  document.getElementById("detailsRemaining").textContent=`$${bal.remaining.toFixed(2)}`;
  document.getElementById("detailsNextDue").textContent=bal.nextDue||"—";
  renderTables(loan);
}
function renderTables(loan){
  const hist=document.getElementById("detailsHistory");
  const fut=document.getElementById("detailsUpcoming");
  const pay=loan.transactions||[];
  const futs=loan.futurePayments||[];
  let run=loan.totalAmount||0;
  hist.innerHTML="<tr class='text-[#d4af37]'><th>Date</th><th>Amt</th><th>Note</th><th>Remain</th></tr>"+
    (pay.map(p=>{run-=p.amount;
      const d=p.date?.toDate?.()||new Date(p.date);
      return `<tr><td>${d.toLocaleDateString()}</td><td>$${p.amount.toFixed(2)}</td><td>${p.note||""}</td><td>$${run.toFixed(2)}</td></tr>`;
    }).join("")||"<tr><td colspan='4' class='text-center py-1 text-xs'>No payments</td></tr>");
  fut.innerHTML="<tr class='text-[#d4af37]'><th>Due</th><th>Amt</th></tr>"+
    (futs.map(f=>`<tr><td>${new Date(f.dueDate).toLocaleDateString()}</td><td>$${f.amount.toFixed(2)}</td></tr>`).join("")||
     "<tr><td colspan='2' class='text-center py-1 text-xs'>No future</td></tr>");
}

/* ───────────── EDIT MODE ───────────── */
editLoanBtn.onclick=()=>{
  editSection.classList.remove("hidden");
  addPaymentSection.classList.remove("hidden");
  document.getElementById("editLoanName").value=currentLoan.data.loanName;
  document.getElementById("editTotalAmount").value=currentLoan.data.totalAmount;
  document.getElementById("editFrequency").value=currentLoan.data.paymentFrequency||"monthly";
};
cancelEditBtn.onclick=()=>{editSection.classList.add("hidden");addPaymentSection.classList.add("hidden");};

/* SAVE CHANGES */
saveEditBtn.onclick=async()=>{
  const ref=doc(db,"loans",currentLoan.uid,"userLoans",currentLoan.id);
  await updateDoc(ref,{
    loanName:document.getElementById("editLoanName").value,
    totalAmount:parseFloat(document.getElementById("editTotalAmount").value)||0,
    paymentFrequency:document.getElementById("editFrequency").value
  });
  editSection.classList.add("hidden"); addPaymentSection.classList.add("hidden");
};

/* ADD PAYMENT */
addPaymentForm.onsubmit=async e=>{
  e.preventDefault();
  const amt=parseFloat(document.getElementById("paymentAmount").value);
  const note=document.getElementById("paymentNote").value;
  if(!amt)return;
  const ref=doc(db,"loans",currentLoan.uid,"userLoans",currentLoan.id);
  const snap=await getDoc(ref);
  const existing=snap.data().transactions||[];
  existing.push({amount:amt,note,date:new Date()});
  await updateDoc(ref,{transactions:existing});
  addPaymentForm.reset();
};

/* ───────────── SECURE DELETE FLOW ───────────── */
deleteLoanBtn.onclick=()=>showModal(passcodeModal);
verifyPasscode.onclick=async()=>{
  const adminPass=adminPassInput.value.trim();
  const passRef=await getDoc(doc(db,"adminSettings","familyTracker"));
  if(!passRef.exists()){alert("Passcode not set");return;}
  if(adminPass!==passRef.data().passcode){alert("Incorrect passcode");return;}
  verifiedPass=true; hideModal(passcodeModal); showModal(overrideModal);
};
confirmOverride.onclick=()=>{
  hideModal(overrideModal);
  if(!verifiedPass){alert("Unauthorized");return;}
  showModal(nameMatchModal);
};
finalDeleteBtn.onclick=async()=>{
  const match=confirmLoanNameInput.value.trim();
  if(match!==currentLoan.data.loanName){alert("Name mismatch");return;}
  await deleteDoc(doc(db,"loans",currentLoan.uid,"userLoans",currentLoan.id));
  hideModal(nameMatchModal); closeModal();
  alert("Loan deleted successfully");
};

/* ───────────── UTILS ───────────── */
function calcBalance(loan){
  const pay=loan.transactions||[], fut=loan.futurePayments||[];
  const paid=pay.reduce((a,b)=>a+b.amount,0);
  const remaining=(loan.totalAmount||0)-paid;
  const nextDue=fut.length?fut.sort((a,b)=>new Date(a.dueDate)-new Date(b.dueDate))[0].dueDate:null;
  return {paid,remaining,nextDue:nextDue?new Date(nextDue).toLocaleDateString():"—"};
}
function showModal(m){m.classList.remove("hidden");}
function hideModal(m){m.classList.add("hidden");}
</script>
</body>
</html>