<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Morrow Industries — Family Payment Tracker (Admin)</title>
  <link rel="icon" href="/morIcon.png" />
  <link rel="stylesheet" href="/assets/css/family-tracker.css" />
  <script src="https://cdn.tailwindcss.com"></script>
  <script type="module" src="/assets/js/firebase-init.js"></script>
</head>

<body class="min-h-screen flex flex-col bg-gradient-to-b from-black to-[#0a0b0f] text-[#e9eef8] font-[Inter] p-6">

  <!-- Header -->
  <header class="flex justify-between items-center mb-6">
    <div class="flex items-center gap-3">
      <img src="/morIcon.png" alt="logo" class="h-8 w-8" />
      <h1 class="text-2xl font-semibold text-[#d4af37]">Family Payment Tracker — Admin</h1>
    </div>
    <button id="logoutBtn" class="bg-[#d4af37] text-black font-semibold rounded-md px-3 py-1 hover:opacity-80 transition">Sign Out</button>
  </header>

  <!-- Dashboard Summary -->
  <section id="summary" class="grid sm:grid-cols-2 lg:grid-cols-4 gap-4 mb-8">
    <div class="summary-card"><h3>Total Balance</h3><p id="totalBalance" class="card-value">$0.00</p></div>
    <div class="summary-card"><h3>Next Due Date</h3><p id="nextDueDate" class="card-value">—</p></div>
    <div class="summary-card"><h3>Next Amount Due</h3><p id="nextAmountDue" class="card-value">$0.00</p></div>
    <div class="summary-card"><h3>Active Loans</h3><p id="activeLoans" class="card-value">0</p></div>
  </section>

  <!-- User List + Loans -->
  <div id="adminPanel" class="grid md:grid-cols-3 gap-6">
    <!-- Users -->
    <div class="glass p-4">
      <h2 class="text-lg font-semibold mb-3 text-[#d4af37]">All Users</h2>
      <div id="userList" class="space-y-2 text-sm"></div>
    </div>

    <!-- Loans -->
    <div class="glass p-4 md:col-span-2">
      <h2 class="text-lg font-semibold mb-3 text-[#d4af37]">User Loans</h2>
      <div id="selectedUserInfo" class="mb-4 text-sm italic"></div>
      <div id="loanList" class="space-y-4"></div>
      <div class="flex justify-end">
        <button id="addLoanBtn" class="bg-[#d4af37] text-black font-semibold rounded-md px-4 py-1 hover:opacity-80 transition mt-4">+ Add Loan</button>
      </div>
    </div>
  </div>

  <!-- Add Loan Modal -->
  <div id="addLoanModal" class="modal hidden">
    <div class="modal-content glass p-6 w-[90%] max-w-lg">
      <h2 class="text-xl font-semibold text-[#d4af37] mb-4">Add New Loan</h2>
      <form id="addLoanForm" class="space-y-3">
        <div>
          <label class="block text-sm mb-1">Loan Name</label>
          <input type="text" name="loanName" required class="form-input" placeholder="e.g. Camry Purchase" />
        </div>
        <div>
          <label class="block text-sm mb-1">Total Amount</label>
          <input type="number" name="totalAmount" required class="form-input" placeholder="e.g. 12000" />
        </div>
        <div class="grid grid-cols-2 gap-3">
          <div>
            <label class="block text-sm mb-1">Start Date</label>
            <input type="date" name="startDate" class="form-input" />
          </div>
          <div>
            <label class="block text-sm mb-1">First Payment Date</label>
            <input type="date" name="firstPaymentDate" class="form-input" />
          </div>
        </div>
        <div>
          <label class="block text-sm mb-1">Payment Frequency</label>
          <select name="paymentFrequency" class="form-input">
            <option value="monthly">Monthly</option>
            <option value="biweekly">Biweekly</option>
            <option value="weekly">Weekly</option>
          </select>
        </div>
        <div>
          <label class="block text-sm mb-1">Loan Icon</label>
          <input type="file" id="loanIconInput" accept="image/*" class="form-input" />
          <img id="loanIconPreview" src="/assets/icons/default-loan.png"
               class="w-16 h-16 mt-2 rounded-md object-cover border border-[rgba(255,255,255,0.1)]" />
        </div>
        <div class="flex justify-end gap-2 pt-4">
          <button type="button" id="cancelAddLoan" class="btn-secondary">Cancel</button>
          <button type="submit" class="btn-primary">Save Loan</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Icon Upload Modal -->
  <div id="iconUploadModal" class="modal hidden">
    <div class="modal-content glass p-6 w-[90%] max-w-md text-center">
      <h2 class="text-xl font-semibold text-[#d4af37] mb-4">Change Loan Icon</h2>
      <img id="iconPreview" src="/assets/icons/default-loan.png"
           class="w-24 h-24 mx-auto rounded-md border border-[rgba(255,255,255,0.1)] object-cover mb-4" />
      <input type="file" id="iconFileInput" accept="image/*" class="form-input mb-4" />
      <div class="flex justify-center gap-3">
        <button id="cancelIconUpload" class="btn-secondary">Cancel</button>
        <button id="confirmIconUpload" class="btn-primary">Upload</button>
      </div>
    </div>
  </div>

  <!-- Overlay -->
  <div id="overlay" class="overlay hidden"></div>

  <!-- Logic to follow in Part 2 -->
<script type="module">
/* ──────────────────────────────
   Morrow Industries — Family Payment Tracker (Admin Logic)
────────────────────────────── */
import {
  auth, db, storage,
  GoogleAuthProvider, signInWithPopup, onAuthStateChanged, signOut,
  collection, doc, getDocs, getDoc, updateDoc, addDoc, onSnapshot, Timestamp,
  ref, uploadBytes, getDownloadURL
} from "/assets/js/firebase-init.js";

/* ─────────── UI Refs ─────────── */
const logoutBtn = document.getElementById("logoutBtn");
const userListEl = document.getElementById("userList");
const loanListEl = document.getElementById("loanList");
const selectedUserInfo = document.getElementById("selectedUserInfo");
const addLoanBtn = document.getElementById("addLoanBtn");

/* Summary */
const totalBalanceEl = document.getElementById("totalBalance");
const nextDueDateEl = document.getElementById("nextDueDate");
const nextAmountDueEl = document.getElementById("nextAmountDue");
const activeLoansEl = document.getElementById("activeLoans");

/* Add-Loan Modal */
const addLoanModal = document.getElementById("addLoanModal");
const addLoanForm = document.getElementById("addLoanForm");
const cancelAddLoan = document.getElementById("cancelAddLoan");
const loanIconInput = document.getElementById("loanIconInput");
const loanIconPreview = document.getElementById("loanIconPreview");

/* Upload Icon Modal */
const iconUploadModal = document.getElementById("iconUploadModal");
const iconPreview = document.getElementById("iconPreview");
const iconFileInput = document.getElementById("iconFileInput");
const cancelIconUpload = document.getElementById("cancelIconUpload");
const confirmIconUpload = document.getElementById("confirmIconUpload");
const overlay = document.getElementById("overlay");

/* ─────────── State ─────────── */
let selectedUser = null;
let uploadedIconFile = null;
let currentLoanForIcon = null;

/* ─────────── Auth Logic ─────────── */
onAuthStateChanged(auth, async user => {
  if (!user) {
    const provider = new GoogleAuthProvider();
    await signInWithPopup(auth, provider);
    return;
  }
  const userDoc = await getDoc(doc(db, "users", user.uid));
  if (!userDoc.exists() || userDoc.data().role_familyTracker !== "admin") {
    window.location = "unauthorized.html";
    return;
  }
  loadUsers();
});
logoutBtn.onclick = () => {
  signOut(auth).then(() => (window.location.href = "index.html"));
};

/* ─────────── Load Users ─────────── */
async function loadUsers() {
  userListEl.innerHTML = "";
  const snap = await getDocs(collection(db, "users"));
  snap.forEach(u => {
    const data = u.data();
    const item = document.createElement("div");
    item.className = "p-2 rounded hover:bg-[var(--border)] cursor-pointer";
    item.innerHTML = `
      <div class="flex justify-between items-center">
        <span>${data.name || data.email}</span>
        <select data-uid="${u.id}" class="bg-transparent border border-[var(--border)] rounded px-1 text-xs">
          <option value="">none</option>
          <option value="admin" ${data.role_familyTracker === "admin" ? "selected" : ""}>admin</option>
          <option value="viewer" ${data.role_familyTracker === "viewer" ? "selected" : ""}>viewer</option>
        </select>
      </div>`;
    item.querySelector("select").addEventListener("change", e => updateUserRole(u.id, e.target.value));
    item.addEventListener("click", () => selectUser(u.id, data));
    userListEl.appendChild(item);
  });
}
async function updateUserRole(uid, role) {
  await updateDoc(doc(db, "users", uid), { role_familyTracker: role || null });
}

/* ─────────── Select User & Watch Loans ─────────── */
function selectUser(uid, data) {
  selectedUser = uid;
  selectedUserInfo.textContent = `Managing loans for: ${data.name || data.email}`;
  loanListEl.innerHTML = "";
  const refCol = collection(db, "loans", uid, "userLoans");
  onSnapshot(refCol, snap => {
    loanListEl.innerHTML = "";
    let totalBal = 0;
    let allFuture = [];
    snap.forEach(docSnap => {
      const loan = docSnap.data();
      renderLoan(uid, docSnap.id, loan);
      const bal = calcBalance(loan);
      totalBal += bal.remaining;
      if (loan.futurePayments) allFuture.push(...loan.futurePayments);
    });
    updateSummary(totalBal, allFuture, snap.size);
  });
}

/* ─────────── Dashboard Summary ─────────── */
function updateSummary(total, futures, count) {
  totalBalanceEl.textContent = `$${total.toFixed(2)}`;
  activeLoansEl.textContent = count;
  if (futures.length) {
    futures.sort((a,b)=>new Date(a.dueDate)-new Date(b.dueDate));
    const next = futures[0];
    nextDueDateEl.textContent = new Date(next.dueDate).toLocaleDateString();
    nextAmountDueEl.textContent = `$${next.amount.toFixed(2)}`;
  } else {
    nextDueDateEl.textContent = "—";
    nextAmountDueEl.textContent = "$0.00";
  }
}

/* ─────────── Render Loan Cards ─────────── */
function renderLoan(uid, loanId, loan) {
  const { loanName, totalAmount=0, loanIcon="/assets/icons/default-loan.png" } = loan;
  const bal = calcBalance(loan);
  const percent = totalAmount ? (bal.paid/totalAmount)*100 : 0;

  const card = document.createElement("div");
  card.className = "glass rounded-lg p-4 transition transform hover:-translate-y-1 hover:shadow-lg";
  card.innerHTML = `
    <div class="flex justify-between items-center cursor-pointer" data-expand="${loanId}">
      <div class="flex items-center gap-3">
        <img src="${loanIcon}" class="w-12 h-12 rounded-md object-cover border border-[rgba(255,255,255,0.1)] cursor-pointer" data-icon-change="${loanId}" />
        <div>
          <h3 class="text-[#d4af37] font-semibold">${loanName}</h3>
          <p class="text-sm text-gray-300">Remaining: $${bal.remaining.toFixed(2)}</p>
        </div>
      </div>
      <div class="text-right">
        <p class="text-sm text-gray-400">Next Due</p>
        <p class="text-sm">${bal.nextDue || "—"}</p>
      </div>
    </div>
    <div class="w-full h-2 bg-[rgba(255,255,255,0.1)] rounded mt-3">
      <div class="h-2 bg-[#d4af37] rounded" style="width:${percent}%"></div>
    </div>
    <div id="details-${loanId}" class="hidden mt-4">${renderLoanDetails(loan, bal)}</div>
  `;
  card.querySelector(`[data-expand="${loanId}"]`).onclick = () => toggleDetails(loanId);
  card.querySelector(`[data-icon-change="${loanId}"]`).onclick = () => openIconModal(uid, loanId);
  loanListEl.appendChild(card);
}

/* ─────────── Loan Calculations ─────────── */
function calcBalance(loan) {
  const payments = loan.transactions || [];
  const totalPaid = payments.reduce((a,t)=>a+t.amount,0);
  const future = loan.futurePayments || [];
  const remaining = (loan.totalAmount||0) - totalPaid;
  const nextDue = future.length ? future.sort((a,b)=>new Date(a.dueDate)-new Date(b.dueDate))[0].dueDate : null;
  return { paid: totalPaid, remaining, nextDue };
}

/* ─────────── Details Section ─────────── */
function renderLoanDetails(loan, bal) {
  const payments = loan.transactions||[];
  const futures = loan.futurePayments||[];
  let running = loan.totalAmount||0;
  const rows = payments.map(p=>{
    running -= p.amount;
    const d=p.date?.toDate?.()||new Date(p.date);
    return `<tr><td>${d.toLocaleDateString()}</td><td>$${p.amount.toFixed(2)}</td><td>${p.note||""}</td><td>$${running.toFixed(2)}</td></tr>`;
  }).join("");
  const futRows = futures.map(f=>`
    <tr><td>${new Date(f.dueDate).toLocaleDateString()}</td><td>$${f.amount.toFixed(2)}</td></tr>`).join("");
  return `
  <div class="glass p-3 rounded mt-3">
    <p class="text-sm mb-2">Total: $${loan.totalAmount?.toFixed(2)||0}</p>
    <p class="text-sm mb-4">Remaining: <span class="text-[#d4af37]">$${bal.remaining.toFixed(2)}</span></p>
    <h4 class="font-semibold text-[#d4af37] mb-1">Payment History</h4>
    <table class="text-sm w-full mb-4 border-t border-[rgba(255,255,255,0.1)]">
      <tr class="text-[#d4af37]"><th>Date</th><th>Amount</th><th>Note</th><th>Remaining</th></tr>
      ${rows || "<tr><td colspan='4' class='text-center py-1 text-xs'>No payments yet</td></tr>"}
    </table>
    <h4 class="font-semibold text-[#d4af37] mb-1">Future Payments</h4>
    <table class="text-sm w-full border-t border-[rgba(255,255,255,0.1)]">
      <tr class="text-[#d4af37]"><th>Due Date</th><th>Amount</th></tr>
      ${futRows || "<tr><td colspan='2' class='text-center py-1 text-xs'>No future payments</td></tr>"}
    </table>
  </div>`;
}
function toggleDetails(id){
  const d=document.getElementById(`details-${id}`);
  d.classList.toggle("hidden");
}

/* ─────────── Add Loan Modal ─────────── */
addLoanBtn.onclick = () => openModal(addLoanModal);
cancelAddLoan.onclick = () => closeModal(addLoanModal);
loanIconInput.onchange = e => {
  const f=e.target.files[0];
  if(!f) return;
  const r=new FileReader();
  r.onload=ev=>loanIconPreview.src=ev.target.result;
  r.readAsDataURL(f);
  uploadedIconFile=f;
};
addLoanForm.onsubmit = async e => {
  e.preventDefault();
  if(!selectedUser) return alert("Select a user first.");
  const fd=new FormData(addLoanForm);
  const loan={
    loanName:fd.get("loanName"),
    totalAmount:parseFloat(fd.get("totalAmount")),
    startDate:fd.get("startDate")||null,
    firstPaymentDate:fd.get("firstPaymentDate")||null,
    paymentFrequency:fd.get("paymentFrequency"),
    createdAt:Timestamp.now(),
    transactions:[],
    futurePayments:[]
  };
  let iconURL="/assets/icons/default-loan.png";
  if(uploadedIconFile){
    const path=`loanIcons/${Date.now()}-${uploadedIconFile.name}`;
    const sRef=ref(storage,path);
    await uploadBytes(sRef,uploadedIconFile);
    iconURL=await getDownloadURL(sRef);
  }
  loan.loanIcon=iconURL;
  await addDoc(collection(db,"loans",selectedUser,"userLoans"),loan);
  addLoanForm.reset();
  loanIconPreview.src="/assets/icons/default-loan.png";
  uploadedIconFile=null;
  closeModal(addLoanModal);
};

/* ─────────── Icon Upload Modal ─────────── */
function openIconModal(uid, loanId){
  currentLoanForIcon={uid,loanId};
  iconPreview.src="/assets/icons/default-loan.png";
  iconFileInput.value="";
  openModal(iconUploadModal);
}
iconFileInput.onchange=e=>{
  const f=e.target.files[0];
  if(f){
    const r=new FileReader();
    r.onload=ev=>iconPreview.src=ev.target.result;
    r.readAsDataURL(f);
    uploadedIconFile=f;
  }
};
cancelIconUpload.onclick=()=>closeModal(iconUploadModal);
confirmIconUpload.onclick=async()=>{
  if(!uploadedIconFile||!currentLoanForIcon) return;
  const path=`loanIcons/${Date.now()}-${uploadedIconFile.name}`;
  const sRef=ref(storage,path);
  await uploadBytes(sRef,uploadedIconFile);
  const url=await getDownloadURL(sRef);
  await updateDoc(doc(db,"loans",currentLoanForIcon.uid,"userLoans",currentLoanForIcon.loanId),{loanIcon:url});
  uploadedIconFile=null;
  currentLoanForIcon=null;
  closeModal(iconUploadModal);
};

/* ─────────── Modal Helpers ─────────── */
function openModal(m){m.classList.remove("hidden");overlay.classList.remove("hidden");}
function closeModal(m){m.classList.add("hidden");overlay.classList.add("hidden");}
</script>
</body>
</html>