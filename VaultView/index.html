<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>VaultView CSS Hub</title>
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js"></script>
</head>
<body style="background: #111; color: gold; font-family: sans-serif; padding: 20px;">
  <h1>VaultView: CSS Manager Hub</h1>
  <div id="debugBox" style="background:#222; border:1px solid gold; padding:10px; margin-bottom:20px; font-family:monospace;"></div>
  <div id="allStylesContainer"></div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
    import {
      getFirestore,
      collection,
      doc,
      onSnapshot,
      setDoc,
      getDocs
    } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyAyWD_KLFAVDOFW7FyHPHYGG1gge2go2AY",
      authDomain: "morrow-industries.firebaseapp.com",
      databaseURL: "https://morrow-industries-default-rtdb.firebaseio.com",
      projectId: "morrow-industries",
      storageBucket: "morrow-industries.appspot.com",
      messagingSenderId: "75190213345",
      appId: "1:75190213345:web:a521b54a1c8e00b68d75a0"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const stylesCollectionRef = collection(db, "styles");
    const allStylesContainer = document.getElementById("allStylesContainer");
    const debugBox = document.getElementById("debugBox");

    function applyCSS(cssString, id) {
      const styleTag = document.getElementById(`style-${id}`) || document.createElement("style");
      styleTag.id = `style-${id}`;
      styleTag.innerHTML = cssString;
      document.head.appendChild(styleTag);
    }

    function splitCSSIntoCards(cssString) {
      return cssString.split(/\}\s*/).filter(Boolean).map(block => block + "}");
    }

    function renderCSSCards(container, cssString, docId) {
      container.innerHTML = "";
      const blocks = splitCSSIntoCards(cssString);

      blocks.forEach(block => {
        const match = block.match(/^([^{]+)\s*\{([^}]+)\}/);
        if (!match) return;

        const selector = match[1].trim();
        const properties = match[2].trim().split(/;\s*/).filter(Boolean);

        const card = document.createElement("div");
        card.classList.add("card");
        card.style = "background:#222; padding:16px; margin:10px 0; border-radius:8px;";
        card.dataset.selector = selector;

        const title = document.createElement("h2");
        title.textContent = selector;
        title.style = "margin-bottom:10px;";
        card.appendChild(title);

        properties.forEach(prop => {
          const [key, value] = prop.split(":").map(s => s.trim());
          if (!key || !value) return;

          const propContainer = document.createElement("div");
          propContainer.style.marginBottom = "8px";

          const label = document.createElement("label");
          label.textContent = key;
          label.style.display = "block";

          const input = document.createElement("input");
          input.type = "text";
          input.name = key;
          input.value = value;
          input.dataset.selector = selector;
          input.style = "width:100%; padding:6px; background:#333; color:gold; border:1px solid gold;";

          propContainer.appendChild(label);
          propContainer.appendChild(input);
          card.appendChild(propContainer);
        });

        container.appendChild(card);
      });
    }

    function collectCSSFromCards(container) {
      const selectors = {};
      const inputs = container.querySelectorAll("input");

      inputs.forEach(input => {
        const selector = input.dataset.selector;
        const prop = input.name;
        const value = input.value;

        if (!selectors[selector]) selectors[selector] = [];
        selectors[selector].push(`${prop}: ${value}`);
      });

      return Object.entries(selectors)
        .map(([selector, rules]) => `${selector} {\n  ${rules.join(";\n  ")};\n}`)
        .join("\n\n");
    }

    function createStyleEditor(docId, initialCSS) {
      const section = document.createElement("section");
      section.style = "border:2px solid gold; padding:16px; margin-bottom:30px; border-radius:12px;";

      const header = document.createElement("div");
      header.style = "display:flex; align-items:center; justify-content:space-between; cursor:pointer; margin-bottom:10px;";

      const title = document.createElement("h2");
      title.textContent = `Stylesheet: ${docId}`;
      title.style.margin = 0;

      const toggleButton = document.createElement("button");
      toggleButton.textContent = "▼";
      toggleButton.style = "font-size: 1.2rem; background:none; border:none; color:gold; cursor:pointer;";

      header.appendChild(title);
      header.appendChild(toggleButton);
      section.appendChild(header);

      const cardsContainer = document.createElement("div");
      cardsContainer.id = `cards-${docId}`;
      section.appendChild(cardsContainer);

      const publishButton = document.createElement("button");
      publishButton.textContent = "✔️ Publish Changes";
      publishButton.style = "margin-top: 10px; padding: 10px; font-size: 1rem;";
      publishButton.addEventListener("click", async () => {
        const css = collectCSSFromCards(cardsContainer);
        await setDoc(doc(db, "styles", docId), { css });
        debugBox.innerText = `CSS for ${docId} updated in Firestore.`;
      });
      section.appendChild(publishButton);

      toggleButton.addEventListener("click", () => {
        const expanded = cardsContainer.style.display !== "none";
        cardsContainer.style.display = expanded ? "none" : "block";
        publishButton.style.display = expanded ? "none" : "inline-block";
        toggleButton.textContent = expanded ? "▶" : "▼";
      });

      allStylesContainer.appendChild(section);

      applyCSS(initialCSS, docId);
      renderCSSCards(cardsContainer, initialCSS, docId);
    }

    // Load all CSS documents and listen to each
    const querySnapshot = await getDocs(stylesCollectionRef);
    querySnapshot.forEach(docSnap => {
      const docId = docSnap.id;
      const data = docSnap.data();
      const css = data?.css || "";
      createStyleEditor(docId, css);

      // Real-time updates
      onSnapshot(doc(db, "styles", docId), (updatedDoc) => {
        const cssString = updatedDoc.data()?.css || "";
        applyCSS(cssString, docId);
        renderCSSCards(document.getElementById(`cards-${docId}`), cssString, docId);
        debugBox.innerText = `Realtime update received for ${docId}.`;
      });
    });
  </script>
</body>
</html>