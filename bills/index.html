<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Morrow Industries ‚Äî Bills Paid Tracker</title>
  <link rel="icon" href="/assets/morIcon.png" />
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    :root {
      --gold: #d4af37;
      --bg: #0a0b0f;
      --surface: rgba(18, 20, 27, 0.7);
      --text: #e9eef8;
      --border: rgba(255, 255, 255, 0.08);
    }
    body {
      background: radial-gradient(circle at center, var(--bg) 0%, #000 100%);
      color: var(--text);
      font-family: "Inter", sans-serif;
      min-height: 100vh;
    }
    .glass {
      background: var(--surface);
      backdrop-filter: blur(16px);
      border: 1px solid var(--border);
      border-radius: 1rem;
      box-shadow: 0 4px 16px rgba(0, 0, 0, 0.4);
    }
    .gold {
      color: var(--gold);
    }
    .btn {
      border: 1px solid var(--border);
      padding: 0.6rem 1rem;
      border-radius: 0.75rem;
      transition: all 0.2s ease;
    }
    .btn:hover {
      background: rgba(212, 175, 55, 0.1);
      border-color: var(--gold);
    }
    .month-circle {
      width: 1.3rem;
      height: 1.3rem;
      border-radius: 50%;
      margin: 0.15rem;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 0.8rem;
      color: #000;
    }
    .status-paid { background: #22c55e; }
    .status-partial { background: #facc15; }
    .status-late { background: #ef4444; }
    .status-unpaid { background: #6b7280; }
    .glow {
      box-shadow: 0 0 20px 4px rgba(212, 175, 55, 0.25);
      transition: box-shadow 0.8s ease-out;
    }
    /* Toast */
    #toast {
      position: fixed;
      bottom: 90px;
      left: 50%;
      transform: translateX(-50%) scale(0.9);
      background: rgba(18, 20, 27, 0.85);
      border: 1px solid var(--gold);
      color: var(--text);
      padding: 0.6rem 1.2rem;
      border-radius: 0.75rem;
      box-shadow: 0 0 15px rgba(212, 175, 55, 0.25);
      opacity: 0;
      pointer-events: none;
      transition: all 0.2s ease;
      z-index: 1000;
      font-size: 0.9rem;
    }
    #toast.show {
      opacity: 1;
      transform: translateX(-50%) scale(1);
    }

    /* Drawer Overlay */
    #drawerOverlay {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.5);
      backdrop-filter: blur(6px);
      display: none;
      z-index: 60;
      justify-content: flex-end;
      flex-direction: column;
    }

    .drawer {
      background: rgba(18, 20, 27, 0.95);
      border-top: 1px solid var(--border);
      border-radius: 1rem 1rem 0 0;
      transform: translateY(100%);
      transition: transform 0.3s ease;
      max-height: 90%;
      overflow-y: auto;
      position: relative;
      padding-bottom: 1rem;
    }
    .drawer.show {
      transform: translateY(0);
    }

    .grab-bar {
      width: 30px;
      height: 4px;
      background: var(--gold);
      border-radius: 2px;
      margin: 10px auto;
      opacity: 0;
      transform: translateY(10px);
      transition: all 0.3s ease;
    }
    .drawer.show .grab-bar {
      opacity: 1;
      transform: translateY(0);
    }
    .drawer-close {
      position: absolute;
      top: 8px;
      right: 12px;
      color: var(--gold);
      font-size: 1.2rem;
      cursor: pointer;
      transition: color 0.2s;
    }
    .drawer-close:hover {
      color: #fff;
    }

    /* Logs styling */
    .log-entry {
      padding: 0.6rem 1rem;
      border-bottom: 1px solid var(--border);
      font-size: 0.85rem;
    }
    .log-normal { color: var(--gold); }
    .log-warn { color: #facc15; }
    .log-error { color: #ef4444; }
  </style>
</head>
<body class="pb-28">
  <!-- Header -->
  <header class="flex items-center justify-between p-4 sticky top-0 bg-black/70 backdrop-blur-md z-50">
    <div class="flex items-center space-x-2">
      <img src="/assets/morIcon.png" alt="Morrow Icon" class="w-8 h-8">
      <h1 class="text-lg font-semibold gold">Bills Paid Tracker</h1>
    </div>
    <button id="authBtn" class="btn">Sign In</button>
  </header>

  <!-- Summary -->
  <section id="summary" class="glass m-4 p-4 grid grid-cols-2 gap-2 text-center">
    <div>‚úÖ Paid: <span id="paidCount" class="gold">0</span></div>
    <div>‚ö†Ô∏è Partial: <span id="partialCount" class="gold">0</span></div>
    <div>‚ùå Unpaid: <span id="unpaidCount" class="gold">0</span></div>
    <div>üí∞ Total: <span id="totalSummary" class="gold">$0 / $0</span></div>
  </section>

  <main id="billsContainer" class="space-y-4 px-4"></main>

  <section id="totals" class="glass m-4 p-4 text-center">
    <div class="mb-2">üìÜ <span id="monthName" class="gold"></span></div>
    <div>This Month ‚Äî Paid: <span id="monthPaid" class="gold">$0</span> | Remaining: <span id="monthRemain" class="gold">$0</span></div>
    <div class="mt-2">This Year ‚Äî Paid: <span id="yearPaid" class="gold">$0</span> | Remaining: <span id="yearRemain" class="gold">$0</span></div>
  </section>

  <!-- Floating Action Buttons -->
  <div class="fixed bottom-6 right-6 flex flex-col space-y-3 z-40">
    <button id="addBillBtn" class="rounded-full bg-[var(--gold)] text-black w-14 h-14 shadow-lg text-3xl">Ôºã</button>
    <button id="paymentBtn" class="rounded-full bg-[var(--gold)] text-black w-14 h-14 shadow-lg text-2xl">üí∞</button>
  </div>
  <button id="logsBtn" class="fixed bottom-6 left-6 bg-[var(--gold)] text-black px-4 py-2 rounded-full shadow-md text-sm z-40">Logs</button>

  <div id="toast"></div>

  <!-- Unified Drawer Overlay -->
  <div id="drawerOverlay" class="hidden flex">
    <!-- Logs Drawer -->
    <div id="logsDrawer" class="drawer w-full">
      <div class="grab-bar"></div>
      <span class="drawer-close">‚úï</span>
      <h2 class="text-center text-lg font-semibold gold mb-2">Logs</h2>
      <div id="logsContainer"></div>
    </div>

    <!-- Manage Bills Drawer -->
    <div id="manageDrawer" class="drawer w-full">
      <div class="grab-bar"></div>
      <span class="drawer-close">‚úï</span>
      <h2 class="text-center text-lg font-semibold gold mb-4">Manage Bills</h2>
      <div class="px-6 pb-6">
        <input id="billName" placeholder="Bill Name" class="w-full mb-3 p-2 rounded bg-black/30 border border-[var(--border)]">
        <input id="billAmount" type="number" placeholder="Amount" class="w-full mb-3 p-2 rounded bg-black/30 border border-[var(--border)]">
        <input id="billDueDay" type="number" placeholder="Due Day (1‚Äì31)" min="1" max="31" class="w-full mb-3 p-2 rounded bg-black/30 border border-[var(--border)]">
        <div class="flex space-x-2">
          <button id="addBill" class="btn flex-1 border-[var(--gold)] gold font-semibold">Add</button>
          <button id="deleteBill" class="btn flex-1 border-red-500 text-red-400">Delete</button>
        </div>
      </div>
    </div>

    <!-- Payment Drawer -->
    <div id="paymentDrawer" class="drawer w-full">
      <div class="grab-bar"></div>
      <span class="drawer-close">‚úï</span>
      <h2 class="text-center text-lg font-semibold gold mb-4">Submit Payment</h2>
      <div class="px-6 pb-6">
        <select id="paymentBillSelect" class="w-full mb-3 p-2 rounded bg-black/30 border border-[var(--border)]"></select>
        <input id="paymentAmount" type="number" placeholder="Amount Paid" class="w-full mb-3 p-2 rounded bg-black/30 border border-[var(--border)]">
        <input id="paymentDate" type="date" class="w-full mb-3 p-2 rounded bg-black/30 border border-[var(--border)]">
        <button id="submitPayment" class="btn w-full border-[var(--gold)] gold font-semibold">Submit</button>
      </div>
    </div>
  </div>

  <script type="module" src="/assets/js/firebase-init.js"></script>
  <script type="module">
    import { app, db, auth, provider, signInWithPopup, onAuthStateChanged, signOut, collection, addDoc, getDocs, getDoc, updateDoc, doc } from "/assets/js/firebase-init.js";

    const overlay = document.getElementById('drawerOverlay');
    const drawers = {
      logs: document.getElementById('logsDrawer'),
      manage: document.getElementById('manageDrawer'),
      payment: document.getElementById('paymentDrawer'),
    };
    const toast = document.getElementById('toast');
    const logsContainer = document.getElementById('logsContainer');
    const logsBtn = document.getElementById('logsBtn');
    const addBillBtn = document.getElementById('addBillBtn');
    const paymentBtn = document.getElementById('paymentBtn');
    const logEntries = [];

    function showDrawer(type) {
      Object.values(drawers).forEach(d => d.classList.remove('show'));
      overlay.style.display = 'flex';
      const drawer = drawers[type];
      drawer.classList.add('show');
    }
    function closeDrawer() {
      Object.values(drawers).forEach(d => d.classList.remove('show'));
      overlay.style.display = 'none';
    }

    overlay.addEventListener('click', e => { if (e.target === overlay) closeDrawer(); });
    document.querySelectorAll('.drawer-close').forEach(btn => btn.addEventListener('click', closeDrawer));

    logsBtn.onclick = () => showDrawer('logs');
    addBillBtn.onclick = () => showDrawer('manage');
    paymentBtn.onclick = () => showDrawer('payment');

    // Toast + Console
    function showToast(msg, color = 'var(--gold)') {
      toast.style.borderColor = color;
      toast.textContent = msg;
      toast.classList.add('show');
      setTimeout(() => toast.classList.remove('show'), 3000);
    }

    const origLog = console.log, origWarn = console.warn, origErr = console.error;
    function logToUI(type, msg, color) {
      const time = new Date().toLocaleTimeString();
      const entry = document.createElement('div');
      entry.className = `log-entry log-${type}`;
      entry.textContent = `[${time}] ${msg}`;
      logsContainer.prepend(entry);
      logEntries.unshift({ time, msg, type });
      showToast(msg, color);
    }
    console.log = (...a) => { origLog(...a); logToUI('normal', a.join(' '), 'var(--gold)'); };
    console.warn = (...a) => { origWarn(...a); logToUI('warn', a.join(' '), '#facc15'); };
    console.error = (...a) => { origErr(...a); logToUI('error', a.join(' '), '#ef4444'); };

    /* --- Firebase Logic --- */
    const authBtn = document.getElementById('authBtn');
    const billsContainer = document.getElementById('billsContainer');
    const currentDate = new Date();
    const monthNames = ["jan","feb","mar","apr","may","jun","jul","aug","sep","oct","nov","dec"];
    const monthDisplay = ["January","February","March","April","May","June","July","August","September","October","November","December"];
    document.getElementById('monthName').textContent = monthDisplay[currentDate.getMonth()];
    let userId = null;

    authBtn.addEventListener('click', () => { if (auth.currentUser) signOut(auth); else signInWithPopup(auth, provider); });
    onAuthStateChanged(auth, (user) => {
      if (user) { userId = user.uid; authBtn.textContent = 'Sign Out'; console.log(`Signed in as ${user.email}`); loadBills(); }
      else { userId = null; authBtn.textContent = 'Sign In'; billsContainer.innerHTML = ''; console.log('Signed out'); }
    });

    function loadBills() {
      const billsRef = collection(db, "users", userId, "Bills");
      import("https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js").then(({ onSnapshot }) => {
        onSnapshot(billsRef, (snapshot) => {
          billsContainer.innerHTML = '';
          snapshot.forEach(docSnap => renderBill(docSnap.id, docSnap.data()));
        });
      });
    }

    function renderBill(id, bill) {
      const card = document.createElement('div');
      card.className = "glass p-4";
      card.id = `bill-${id}`;
      card.innerHTML = `
        <div class="flex justify-between items-center mb-2">
          <h3 class="text-lg font-semibold gold">${bill.name}</h3>
          <div class="text-sm opacity-80">$${bill.amount}</div>
        </div>
        <div class="text-xs mb-2">Due: ${bill.dueDay} | Last Paid: ${bill.lastPaid ? new Date(bill.lastPaid.seconds*1000).toLocaleDateString() : 'Never'}</div>
        <div class="flex flex-wrap mb-2">
          ${monthNames.map(m => {
            const s = bill.months?.[m] || 'unpaid';
            const i = s==='paid'?'‚úì':s==='partial'?'‚úì':s==='late'?'‚úï':'';
            const c = s==='paid'?'status-paid':s==='partial'?'status-partial':s==='late'?'status-late':'status-unpaid';
            return `<div class="month-circle ${c}">${i}</div>`;
          }).join('')}
        </div>
        <div class="text-sm border-t border-[var(--border)] pt-2">
          ${(bill.transactions || []).slice().reverse().map(t =>
            `<div>üí≥ $${t.amountPaid} ‚Äî ${new Date(t.date.seconds*1000).toLocaleDateString()} (${t.status})</div>`
          ).join('')}
        </div>`;
      billsContainer.appendChild(card);
    }

    document.getElementById('addBill').onclick = async () => {
      if (!userId) return;
      const name = document.getElementById('billName').value;
      const amount = parseFloat(document.getElementById('billAmount').value);
      const dueDay = parseInt(document.getElementById('billDueDay').value);
      if (!name || !amount || !dueDay) return showToast('Fill all fields', '#facc15');
      await addDoc(collection(db, "users", userId, "Bills"), { name, amount, dueDay, lastPaid: null, months: {}, transactions: [] });
      showToast('Bill added', 'var(--gold)');
      closeDrawer();
    };

    document.getElementById('deleteBill').onclick = async () => {
      const name = document.getElementById('billName').value;
      if (!name) return;
      const billsRef = collection(db, "users", userId, "Bills");
      const snap = await getDocs(billsRef);
      snap.forEach(async d => { if (d.data().name === name) { await import("https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js").then(({ deleteDoc }) => deleteDoc(d.ref)); } });
      showToast('Bill deleted', '#ef4444');
      closeDrawer();
    };

    function populateBillSelect() {
      const select = document.getElementById('paymentBillSelect');
      select.innerHTML = '';
      getDocs(collection(db, "users", userId, "Bills")).then(snap => {
        snap.forEach(d => {
          const o = document.createElement('option');
          o.value = d.id;
          o.textContent = d.data().name;
          select.appendChild(o);
        });
      });
      document.getElementById('paymentDate').valueAsDate = new Date();
    }

    document.getElementById('submitPayment').onclick = async () => {
      const billId = document.getElementById('paymentBillSelect').value;
      const amountPaid = parseFloat(document.getElementById('paymentAmount').value);
      const datePaid = new Date(document.getElementById('paymentDate').value);
      if (!billId || isNaN(amountPaid)) return showToast('Enter valid payment', '#facc15');
      const billRef = doc(db, "users", userId, "Bills", billId);
      const billSnap = await getDoc(billRef);
      if (!billSnap.exists()) return;
      const bill = billSnap.data();
      const monthKey = monthNames[datePaid.getMonth()];
      let status = 'paid';
      if (amountPaid < bill.amount) status = 'partial';
      if (datePaid.getDate() > bill.dueDay) status = 'late';
      const newMonths = { ...bill.months, [monthKey]: status };
      const newTransactions = bill.transactions || [];
      newTransactions.push({ date: { seconds: datePaid.getTime() / 1000 }, amountPaid, status });
      await updateDoc(billRef, { months: newMonths, lastPaid: datePaid, transactions: newTransactions });
      showToast('Payment submitted', 'var(--gold)');
      closeDrawer();
      const card = document.getElementById(`bill-${billId}`);
      if (card) { card.classList.add('glow'); setTimeout(() => card.classList.remove('glow'), 1000); }
    };
  </script>
</body>
</html>
