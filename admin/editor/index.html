<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Morrow Industries — Code Editor</title>
  <link rel="icon" href="/assets/favicon.ico" />
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    :root {
      --bg: #0a0b0f;
      --surface: #12141b;
      --muted: #a9b0be;
      --text: #e9eef8;
      --gold: #d4af37;
      --border: rgba(255, 255, 255, 0.08);
    }

    body {
      background: var(--bg);
      color: var(--text);
    }

    .glass {
      background: rgba(18, 20, 27, .6);
      backdrop-filter: saturate(140%) blur(14px);
      border: 1px solid var(--border);
    }

    .btn {
      border: 1px solid var(--border);
      color: var(--text);
      padding: .55rem .9rem;
      border-radius: .6rem;
      transition: transform .15s ease, box-shadow .2s ease, background .2s ease;
    }

    .btn-primary {
      border-color: var(--gold);
    }

    .btn:hover {
      transform: translateY(-1px);
      box-shadow: 0 8px 24px rgba(0,0,0,.35);
    }

    textarea.editor {
      width: 100%;
      height: 380px;
    }
  </style>

  <!-- CodeMirror -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/codemirror.min.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/codemirror.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/mode/xml/xml.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/mode/css/css.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/mode/javascript/javascript.min.js"></script>
</head>

<body class="min-h-screen selection:bg-[var(--gold)]/20">
  <main class="mx-auto max-w-7xl px-4 py-8">
    <h1 class="font-serif text-3xl mb-2">Morrow Industries — Editor</h1>
    <p class="text-[var(--muted)] mb-6">Your work saves automatically to Firestore under <span class="text-[var(--gold)]">editorprojects</span>.</p>

    <!-- Project Controls -->
    <div class="glass rounded-xl p-4 mb-6">
      <div class="flex flex-wrap gap-2 items-center justify-between">
        <div class="flex gap-2">
          <button id="newProjectBtn" class="btn btn-primary text-sm">New Project</button>
          <button id="saveBtn" class="btn text-sm">Save Now</button>
        </div>
        <div id="status" class="text-sm text-[var(--muted)]">Idle</div>
      </div>
    </div>

    <!-- Tabs -->
    <div class="flex gap-2 text-sm mb-3">
      <button data-tab="html" class="tab-btn btn btn-primary">HTML</button>
      <button data-tab="css" class="tab-btn btn">CSS</button>
      <button data-tab="js" class="tab-btn btn">JS</button>
    </div>

    <!-- Editors -->
    <div class="glass rounded-xl p-4">
      <textarea id="htmlEditor" class="editor"></textarea>
      <textarea id="cssEditor" class="editor hidden"></textarea>
      <textarea id="jsEditor" class="editor hidden"></textarea>
    </div>

    <!-- Live preview link -->
    <div class="mt-6 flex justify-end">
      <a href="/admin/editor/preview.html" target="_blank" class="btn btn-primary text-sm">Open Live Preview</a>
    </div>
  </main>

  <script type="module">
    import { db } from "/assets/js/firebase-init.js";
    import { doc, setDoc, getDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

    const htmlTA = document.getElementById("htmlEditor");
    const cssTA = document.getElementById("cssEditor");
    const jsTA = document.getElementById("jsEditor");
    const status = document.getElementById("status");
    const saveBtn = document.getElementById("saveBtn");

    let currentProjectId = localStorage.getItem("previewProjectId") || "default";
    let htmlEditor, cssEditor, jsEditor;
    let saveTimeout;

    function setupCodeMirror() {
      htmlEditor = CodeMirror.fromTextArea(htmlTA, { mode: "xml", lineNumbers: true });
      cssEditor = CodeMirror.fromTextArea(cssTA, { mode: "css", lineNumbers: true });
      jsEditor = CodeMirror.fromTextArea(jsTA, { mode: "javascript", lineNumbers: true });

      [htmlEditor, cssEditor, jsEditor].forEach(editor => {
        editor.on("change", autoSave);
      });
    }

    // Tab switching
    document.querySelectorAll(".tab-btn").forEach(btn => {
      btn.addEventListener("click", () => {
        document.querySelectorAll(".tab-btn").forEach(b => b.classList.remove("btn-primary"));
        btn.classList.add("btn-primary");

        const tab = btn.dataset.tab;
        document.querySelectorAll("textarea.editor, .CodeMirror").forEach(e => e.classList.add("hidden"));
        if (tab === "html") htmlEditor.getWrapperElement().classList.remove("hidden");
        if (tab === "css") cssEditor.getWrapperElement().classList.remove("hidden");
        if (tab === "js") jsEditor.getWrapperElement().classList.remove("hidden");
      });
    });

    // Auto-save with debounce
    async function autoSave() {
      clearTimeout(saveTimeout);
      saveTimeout = setTimeout(async () => {
        await saveProject();
      }, 1000);
    }

    async function saveProject() {
      const html = htmlEditor.getValue();
      const css = cssEditor.getValue();
      const js = jsEditor.getValue();
      status.textContent = "Saving…";
      await setDoc(doc(db, "editorprojects", currentProjectId), {
        html, css, js, updatedAt: serverTimestamp()
      });
      status.textContent = "Saved ✔";
    }

    saveBtn.addEventListener("click", saveProject);

    setupCodeMirror();
  </script>
</body>
</html>
