<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Morrow Industries â€” Admin Dashboard</title>
  <link rel="icon" href="/assets/favicon.ico"/>
  <script src="https://cdn.tailwindcss.com"></script>

  <style>
    :root {
      --bg:#000;--surface:#12141b;--muted:#a9b0be;--text:#e9eef8;
      --gold:#d4af37;--border:rgba(255,255,255,0.08);
    }
    body{background:var(--bg);color:var(--text);font-family:system-ui,sans-serif}
    .glass{background:rgba(18,20,27,.6);backdrop-filter:saturate(140%) blur(14px);
      border:1px solid var(--border)}
    .btn{border:1px solid var(--border);color:var(--text);
      padding:.6rem .9rem;border-radius:.6rem;
      transition:transform .15s,box-shadow .2s,background .2s}
    .btn-primary{border-color:var(--gold)}
    .btn:hover{transform:translateY(-1px);box-shadow:0 8px 24px rgba(0,0,0,.35)}
    .tab{border:1px solid var(--border);border-radius:.6rem;padding:.45rem .8rem}
    .tab.active{border-color:var(--gold);color:var(--gold)}
    .card{border:1px solid var(--border);border-radius:1rem}
    .navbar a{opacity:.9}.navbar a:hover{opacity:1}

    /* Toasts */
    .toast{position:fixed;right:1.25rem;top:1.25rem;
      background:rgba(18,20,27,.92);color:#e9eef8;border:1px solid var(--gold);
      border-radius:.75rem;padding:.6rem .9rem;font-size:.9rem;
      backdrop-filter:blur(14px);box-shadow:0 4px 16px rgba(0,0,0,.4);
      z-index:9999;animation:fadeIn .2s ease}
    @keyframes fadeIn{from{opacity:0;transform:translateY(-8px)}to{opacity:1;transform:none}}

    /* Spinner + Overlays */
    #loadingOverlay{position:fixed;inset:0;z-index:200;background:rgba(10,11,15,.85);
      backdrop-filter:blur(10px);display:none}
    .spinner{width:56px;height:56px;border-radius:50%;
      border:3px solid rgba(212,175,55,.25);border-top-color:var(--gold);
      animation:spin .8s linear infinite}
    @keyframes spin{to{transform:rotate(360deg)}}

    #accessDenied{position:fixed;inset:0;display:none;z-index:999;
      background:rgba(10,11,15,.96);backdrop-filter:blur(14px)}

    input,textarea,select{
      background:transparent!important;color:var(--gold)!important;
      border:1px solid var(--border);border-radius:.5rem;padding:.75rem;width:100%}
    input::placeholder,textarea::placeholder,select option{
      color:rgba(212,175,55,.5)!important}
    select{
      appearance:none;
      background-image:linear-gradient(45deg,transparent 50%,var(--gold) 50%),
                       linear-gradient(135deg,var(--gold) 50%,transparent 50%);
      background-position:calc(100% - 20px) calc(1em + 2px),
                           calc(100% - 15px) calc(1em + 2px);
      background-size:5px 5px,5px 5px;background-repeat:no-repeat}
    input:focus,textarea:focus,select:focus{
      outline:none;border-color:var(--gold);
      box-shadow:0 0 0 2px rgba(212,175,55,.25)}
    label{color:var(--gold)}
    .fab{position:fixed;right:1.25rem;bottom:1.25rem;background:rgba(18,20,27,.85);
      color:var(--gold);border:1px solid var(--gold);width:58px;height:58px;
      border-radius:50%;display:flex;align-items:center;justify-content:center;
      font-size:1.6rem;box-shadow:0 6px 24px rgba(0,0,0,.45);
      backdrop-filter:blur(14px);transition:transform .2s,box-shadow .2s;z-index:40}
    .fab:hover{transform:scale(1.05);box-shadow:0 8px 28px rgba(0,0,0,.55)}
    #productModal{
    position: absolute;
    top:0px;
    left:0px;
    }
  </style>
</head>
<body class="min-h-screen selection:bg-[var(--gold)]/20">
<div id="navbar-container"></div>
<script>
  fetch("/assets/modules/navbar.html")
    .then(res => res.text())
    .then(html => {
      const container = document.getElementById("navbar-container");
      container.innerHTML = html;

      // Re-run scripts (for burger + auth)
      container.querySelectorAll("script").forEach(oldScript => {
        const s = document.createElement("script");
        s.type = oldScript.type || "text/javascript";
        if (oldScript.src) s.src = oldScript.src;
        else s.textContent = oldScript.textContent;
        document.body.appendChild(s);
        oldScript.remove();
      });
    });
</script>
<header class="sticky top-0 z-50 border-b border-[var(--border)] bg-[var(--bg)]/80 backdrop-blur">
  
</header>

<!-- Loading overlay -->
<div id="loadingOverlay" class="flex items-center justify-center">
  <div class="glass p-6 rounded-2xl flex items-center gap-4">
    <div class="spinner"></div>
    <div class="text-sm text-[var(--muted)]">Checking admin accessâ€¦</div>
  </div>
</div>

<main class="mx-auto max-w-7xl px-4 py-10 my-10">
  <h1 class="font-serif text-4xl">Admin Dashboard</h1>
  <p class="mt-2 text-[var(--muted)]">Manage store, projects, and users.</p>
<div id="debugToggle" class="flex items-center gap-3 mt-6">
  <label class="text-[var(--gold)] font-medium">Debug Mode</label>
  <label class="relative inline-flex items-center cursor-pointer">
    <input id="debugSwitch" type="checkbox" class="sr-only peer">
    <div class="w-11 h-6 bg-[var(--border)] peer-focus:outline-none 
                rounded-full peer peer-checked:after:translate-x-full 
                peer-checked:after:border-white after:content-[''] 
                after:absolute after:top-[2px] after:left-[2px] 
                after:bg-[var(--gold)] after:border-[var(--gold)] 
                after:border after:rounded-full after:h-5 after:w-5 
                after:transition-all peer-checked:bg-[var(--gold)]/30"></div>
  </label>
</div>
<div id="maintenance-module"></div>
<script>
  fetch("/assets/modules/maintenance-toggle.html")
    .then(res => res.text())
    .then(html => {
      const container = document.getElementById("maintenance-module");
      container.innerHTML = html;

      // âœ… Re-execute all scripts in the loaded module
      container.querySelectorAll("script").forEach(oldScript => {
        const s = document.createElement("script");
        s.type = oldScript.type || "text/javascript";
        if (oldScript.src) s.src = oldScript.src; // external scripts
        else s.textContent = oldScript.textContent; // inline scripts
        document.body.appendChild(s);
        oldScript.remove();
      });
    })
    .catch(err => console.error("Error loading maintenance module:", err));
</script>
  <div class="mt-6 flex flex-wrap gap-2">
    <button class="tab active" data-tab="products">Products</button>
    <button class="tab" data-tab="orders">Orders</button>
    <button class="tab" data-tab="users">Users</button>
<button class="tab" data-tab="promos">Promos</button>
    <button class="tab" data-tab="projects">Projects</button>
    <button class="tab" data-tab="editor">Code Editor</button>
  </div>
<section id="panel-promos" class="hidden"></section>
<script>
fetch("/assets/modules/promos.html")
  .then(res => res.text())
  .then(html => {
    const container = document.getElementById("panel-promos");
    container.innerHTML = html;

    // Re-run embedded scripts so the modal + logic initialize
    container.querySelectorAll("script").forEach(oldScript => {
      const s = document.createElement("script");
      s.type = oldScript.type || "text/javascript";
      if (oldScript.src) s.src = oldScript.src;
      else s.textContent = oldScript.textContent;
      document.body.appendChild(s);
      oldScript.remove();
    });
  });
</script>
  <section id="panel-products" class="mt-6 grid sm:grid-cols-2 lg:grid-cols-3 gap-5"></section>
  <section id="panel-orders" class="mt-6 hidden"></section>
  <section id="panel-users" class="mt-6 hidden"></section>
  <section id="panel-projects" class="mt-6 hidden"></section>
  <section id="panel-editor" class="mt-6 hidden"></section>
</main>

<!-- Access Denied -->
<div id="accessDenied" class="flex items-center justify-center">
  <div class="glass p-8 rounded-2xl text-center max-w-sm">
    <h2 class="text-2xl font-serif text-[var(--gold)] mb-3">Access Denied</h2>
    <p class="text-[var(--muted)] mb-5">Admin privileges required to view this page.</p>
    <button id="denySignOut" class="btn btn-primary">Sign Out</button>
  </div>
</div>

<script>
  function showToast(msg){
    const t=document.createElement('div');
    t.className='toast';t.textContent=msg;
    document.body.appendChild(t);setTimeout(()=>t.remove(),3000);
  }
</script>




<!-- Floating Add-Product button -->
<button id="addFab" class="fab" title="+ Add Product" style="display:none;">ï¼‹</button>

<!-- Add / Edit Product Modal -->
<div id="productModal" class="modal-overlay" style="display:none;">
  <div class="mx-auto modal glass card p-6 rounded-2xl mt-20">
    <div class="flex items-center justify-between">
      <h2 id="modalTitle" class="text-2xl font-serif text-[var(--gold)]">Add Product</h2>
      <button id="closeModal" class="btn">Close</button>
    </div>
    <form id="productForm" class="grid md:grid-cols-2 gap-4 mt-5">
      <label>Title<input id="p_title" placeholder="Title" required/></label>
      <label>Category<input id="p_category" placeholder="Category (e.g., Accessories)"/></label>
      <label class="md:col-span-2">Description
        <textarea id="p_description" rows="4" placeholder="Description"></textarea>
      </label>
      <label>Price (USD)<input id="p_price" type="number" step="0.01" min="0" placeholder="0.00" required/></label>
      <label>Colors<input id="p_colors" placeholder="Colors (comma separated)"/></label>
      <label>Availability
        <select id="p_availability">
          <option value="in_stock">In Stock</option>
          <option value="made_to_order">Made to Order</option>
        </select>
      </label>
      <label>Estimated Delivery<input id="p_estimated" placeholder="e.g., 3â€“5 business days"/></label>
      <label class="md:col-span-2">Product Image<input id="p_image" type="file" accept="image/*"/></label>
      <div class="md:col-span-2 flex gap-3 items-center">
        <button id="saveProduct" class="btn btn-primary" type="submit">Save</button>
        <span id="modalStatus" class="text-sm text-[var(--muted)]"></span>
      </div>
    </form>
  </div>
</div>
<!-- 1ï¸âƒ£ All Admin Logic in One Module -->
<script type="module">
  import { auth, provider, db, storage } from "/assets/js/firebase-init.js";
  import { signInWithPopup, signOut, onAuthStateChanged } 
    from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
  import { 
    doc, getDoc, collection, addDoc, updateDoc, deleteDoc, query, orderBy, onSnapshot 
  } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
  import { ref, uploadBytes, getDownloadURL, deleteObject } 
    from "https://www.gstatic.com/firebasejs/10.12.2/firebase-storage.js";

  // === Global UI Elements ===
  const authBtn = document.getElementById('authBtn');
  const userLabel = document.getElementById('userLabel');
  const loadingOverlay = document.getElementById('loadingOverlay');
  const accessDenied = document.getElementById('accessDenied');
  const denySignOut = document.getElementById('denySignOut');
  const addFab = document.getElementById("addFab");

  const panelProducts = document.getElementById("panel-products");
  const panelOrders = document.getElementById("panel-orders");
  const panelUsers = document.getElementById("panel-users");
  const panelProjects = document.getElementById("panel-projects");
  const panelEditor = document.getElementById("panel-editor");

  // === Utility ===
  function showToast(msg){
    const t=document.createElement('div');
    t.className='toast';t.textContent=msg;
    document.body.appendChild(t);setTimeout(()=>t.remove(),3000);
  }
  function setLoading(v){loadingOverlay.style.display=v?'flex':'none';}

  // === Auth ===
  authBtn.onclick=()=>auth.currentUser?signOut(auth):signInWithPopup(auth,provider);
  denySignOut.onclick=()=>signOut(auth);

  // === Tabs ===
  const tabs=document.querySelectorAll('.tab');
  const panels=['products','orders','users','projects','editor','promos'].map(id=>document.getElementById('panel-'+id));
  tabs.forEach(t=>t.addEventListener('click',()=>{
    tabs.forEach(x=>x.classList.remove('active'));t.classList.add('active');
    panels.forEach(p=>p.classList.toggle('hidden',p.id!=='panel-'+t.dataset.tab));
  }));

  // === Product Management ===
  const productModal=document.getElementById("productModal");
  const modalTitle=document.getElementById("modalTitle");
  const closeModalBtn=document.getElementById("closeModal");
  const productForm=document.getElementById("productForm");
  const modalStatus=document.getElementById("modalStatus");
  const p_title=document.getElementById("p_title");
  const p_category=document.getElementById("p_category");
  const p_description=document.getElementById("p_description");
  const p_price=document.getElementById("p_price");
  const p_colors=document.getElementById("p_colors");
  const p_availability=document.getElementById("p_availability");
  const p_estimated=document.getElementById("p_estimated");
  const p_image=document.getElementById("p_image");

  let editId=null, unsubProducts=null;

  function clearProductsGrid(){panelProducts.innerHTML="";if(unsubProducts){unsubProducts();unsubProducts=null;}}
  function openModal(){productModal.style.display="block";}
  function closeModal(){productModal.style.display="none";}
  closeModalBtn.addEventListener("click",closeModal);
  productModal.addEventListener("click",e=>{if(e.target===productModal)closeModal();});
  window.addEventListener("keydown",e=>{if(e.key==="Escape"&&productModal.style.display==="block")closeModal();});
  addFab.addEventListener("click",()=>{editId=null;modalTitle.textContent="Add Product";productForm.reset();modalStatus.textContent="";openModal();});

  async function openEdit(id){
    editId=id;modalTitle.textContent="Edit Product";modalStatus.textContent="Loadingâ€¦";openModal();
    const s=await getDoc(doc(db,"products",id));
    modalStatus.textContent="";
    if(!s.exists()){showToast("Not found");return closeModal();}
    const p=s.data();
    p_title.value=p.title||"";p_category.value=p.category||"";
    p_description.value=p.description||"";p_price.value=p.price||"";
    p_colors.value=(p.colors||[]).join(", ");
    p_availability.value=p.availability==="in_stock"?"in_stock":"made_to_order";
    p_estimated.value=p.estimatedDelivery||"";
  }

  function productCard(id,p){
    const availability=p.availability==="in_stock"?"In Stock":"Made to Order";
    const colors=(p.colors||[]).join(" â€¢ ");
    const img=p.image?`<img src="${p.image}" alt="${p.title}" class="w-full h-36 object-cover rounded-t-2xl border-b border-[var(--border)]">`:"";
    return `
      <article class="glass card overflow-hidden">
        ${img}
        <div class="p-4">
          <div class="text-xs text-[var(--muted)]">${p.category||"General"} â€¢ ${availability}</div>
          <h3 class="mt-1 text-lg font-semibold text-[var(--gold)]">${p.title||"Untitled"}</h3>
          <div class="mt-1 text-sm text-[var(--muted)]">${p.description||""}</div>
          <div class="mt-3 font-semibold text-[var(--gold)]">$${Number(p.price||0).toFixed(2)}</div>
          <div class="mt-1 text-sm text-[var(--muted)]">${colors?("Colors: "+colors):""}</div>
          <div class="mt-1 text-sm text-[var(--muted)]">ETA: ${p.estimatedDelivery||"â€”"}</div>
          <div class="mt-4 flex gap-2">
            <button class="btn btn-primary" data-edit="${id}">Edit</button>
            <button class="btn" data-delete="${id}">Delete</button>
          </div>
        </div>
      </article>`;
  }

  function bindProducts(){
    const q=query(collection(db,"products"),orderBy("createdAt","desc"));
    unsubProducts=onSnapshot(q,snap=>{
      if(snap.empty){panelProducts.innerHTML=`<div class="glass card p-6 text-[var(--muted)]">No products yet.</div>`;return;}
      const html=[];snap.forEach(d=>html.push(productCard(d.id,d.data())));
      panelProducts.innerHTML=html.join("");
      document.querySelectorAll("[data-edit]").forEach(b=>b.addEventListener("click",()=>openEdit(b.dataset.edit)));
      document.querySelectorAll("[data-delete]").forEach(b=>b.addEventListener("click",()=>deleteProduct(b.dataset.delete)));
    });
  }

  productForm.addEventListener("submit",async e=>{
    e.preventDefault();modalStatus.textContent="Savingâ€¦";
    const title=p_title.value.trim(),description=p_description.value.trim();
    const category=p_category.value.trim(),price=Number(p_price.value||0);
    const colors=p_colors.value.split(",").map(s=>s.trim()).filter(Boolean);
    const availability=p_availability.value,estimatedDelivery=p_estimated.value.trim();
    const file=p_image.files[0];let image=null,imagePath=null;
    if(file){
      const path=`products/images/${Date.now()}-${file.name}`;
      const r=ref(storage,path);await uploadBytes(r,file);
      image=await getDownloadURL(r);imagePath=path;
    }
    try{
      if(editId){
        const refDoc=doc(db,"products",editId);
        const prev=await getDoc(refDoc);
        const data={title,description,category,price,availability,colors,estimatedDelivery,updatedAt:new Date()};
        if(image){data.image=image;data.imagePath=imagePath;
          if(prev.exists()&&prev.data().imagePath&&prev.data().imagePath!==imagePath){
            try{await deleteObject(ref(storage,prev.data().imagePath));}catch{}}
        }
        await updateDoc(refDoc,data);showToast("Product updated");
      }else{
        await addDoc(collection(db,"products"),{title,description,category,price,availability,colors,estimatedDelivery,image,imagePath,createdAt:new Date(),updatedAt:new Date()});
        showToast("Product added");
      }
      modalStatus.textContent="Saved.";closeModal();
    }catch(err){console.error(err);modalStatus.textContent="Error";}
  });

  async function deleteProduct(id){
    if(!confirm("Delete this product?"))return;
    try{
      const dref=doc(db,"products",id);const snap=await getDoc(dref);
      if(snap.exists()&&snap.data().imagePath){try{await deleteObject(ref(storage,snap.data().imagePath));}catch{}}
      await deleteDoc(dref);showToast("Deleted");
    }catch(e){showToast("Delete failed");console.error(e);}
  }

  // === Orders ===
  // === Orders ===
function bindOrders() {
  const q = query(collection(db, "orders"), orderBy("createdAt", "desc"));
  onSnapshot(q, async (snap) => {
    if (snap.empty) {
      panelOrders.innerHTML = `
        <div class="glass card p-6 text-[var(--muted)]">
          No orders yet.
        </div>`;
      return;
    }

    const html = [];
    for (const docSnap of snap.docs) {
      const d = docSnap.data();
      const date = d.createdAt?.seconds
        ? new Date(d.createdAt.seconds * 1000).toLocaleString()
        : "â€”";

      // ðŸ”¹ Look up user's display name from users collection
      let displayName = "Unknown User";
      if (d.userId) {
        try {
          const userSnap = await getDoc(doc(db, "users", d.userId));
          if (userSnap.exists()) {
            const userData = userSnap.data();
            displayName = userData.displayName || userData.email || d.userId;
          }
        } catch (err) {
          console.warn("Error fetching user:", err);
        }
      }

      const items = Array.isArray(d.items)
        ? d.items
            .map(
              (it) => `
          <li class='border-b border-[var(--border)] py-1 flex justify-between'>
            <span>${it.title || "Item"}</span>
            <span class='text-[var(--muted)]'>
              $${Number(it.price || 0).toFixed(2)} Ã— ${it.qty || 1}
            </span>
          </li>`
            )
            .join("")
        : "<li class='text-[var(--muted)] italic'>No items</li>";

      const status = d.status || "Pending";
      const lifecycle = Array.isArray(d.lifecycle) ? d.lifecycle : [];

      html.push(`
        <article class='glass card p-5'>
          <div class='flex items-center justify-between'>
            <h3 class='text-lg font-semibold text-[var(--gold)]'>
              Order #${docSnap.id.slice(-6)}
            </h3>
            <span class='text-sm text-[var(--muted)]'>${date}</span>
          </div>
          <p class='mt-1 text-sm text-[var(--muted)]'>
            Customer: <span class='text-[var(--gold)]'>${displayName}</span>
          </p>
          <ul class='mt-3 text-sm'>${items}</ul>
          <div class='mt-4 flex items-center justify-between'>
            <span class='font-semibold text-[var(--gold)]'>${status}</span>
            <select data-id='${docSnap.id}'
              class='bg-transparent border border-[var(--border)] text-[var(--gold)] rounded px-2 py-1 text-sm'>
              ${lifecycle
                .map(
                  (s) => `
                <option value='${s}' ${s === status ? "selected" : ""}>${s}</option>`
                )
                .join("")}
            </select>
          </div>
        </article>`);
    }

    panelOrders.innerHTML = `
      <div class='grid md:grid-cols-2 lg:grid-cols-3 gap-5'>
        ${html.join("")}
      </div>`;

    // === Attach status update events ===
    document.querySelectorAll("#panel-orders select").forEach((sel) => {
      sel.addEventListener("change", async (e) => {
        const id = e.target.dataset.id;
        const newStatus = e.target.value;
        try {
          await updateDoc(doc(db, "orders", id), { status: newStatus });
          showToast("Status updated");
        } catch (err) {
          console.error(err);
          showToast("Error updating order");
        }
      });
    });
  });
}

  // === Users ===
  function bindUsers(){
    const q=query(collection(db,"users"),orderBy("createdAt","desc"));
    onSnapshot(q,snap=>{
      if(snap.empty){panelUsers.innerHTML=`<div class="glass card p-6 text-[var(--muted)]">No users found.</div>`;return;}
      const html=[];
      snap.forEach(docSnap=>{
        const d=docSnap.data();
        const date=d.createdAt?.seconds?new Date(d.createdAt.seconds*1000).toLocaleString():"â€”";
        html.push(`
          <article class='glass card p-5'>
            <div class='flex items-center justify-between'>
              <h3 class='text-lg font-semibold text-[var(--gold)]'>${d.displayName||"Unnamed"}</h3>
              <span class='text-xs text-[var(--muted)]'>${date}</span>
            </div>
            <p class='mt-1 text-sm text-[var(--muted)]'>${d.email||"â€”"}</p>
            <div class='mt-3 flex items-center justify-between'>
              <span class='font-semibold text-[var(--gold)] capitalize'>${d.role||"client"}</span>
              <div class='flex gap-2'>
                <button class='btn text-sm' data-role='client' data-id='${docSnap.id}'>Client</button>
                <button class='btn btn-primary text-sm' data-role='admin' data-id='${docSnap.id}'>Admin</button>
              </div>
            </div>
          </article>`);
      });
      panelUsers.innerHTML=`<div class='grid md:grid-cols-2 lg:grid-cols-3 gap-5'>${html.join("")}</div>`;
      document.querySelectorAll("#panel-users [data-role]").forEach(btn=>{
        btn.addEventListener("click",async e=>{
          const id=e.target.dataset.id;
          const newRole=e.target.dataset.role;
          try{await updateDoc(doc(db,"users",id),{role:newRole});showToast("Role updated to "+newRole);}
          catch(err){console.error(err);showToast("Error updating role");}
        });
      });
    });
  }

  // === Auth Logic + Data Binding ===
  setLoading(true);
  onAuthStateChanged(auth,async user=>{
    try{
      if(!user){accessDenied.style.display='flex';return setLoading(false);}
      const snap=await getDoc(doc(db,"users",user.uid));
      const isAdmin=snap.exists()&&snap.data().role==='admin';
      accessDenied.style.display=isAdmin?'none':'flex';
      if(isAdmin){
        addFab.style.display="flex";
        bindProducts();
        bindOrders();
        bindUsers();
      }
    }catch(e){console.error(e);showToast('Auth error');}
    finally{setLoading(false);}
  });
</script>

<!-- 2ï¸âƒ£ Debug Toggle Script at the very bottom -->
<script type="module">
  import { initDebugToggle } from "/assets/js/debug-toggle.js";
  initDebugToggle();
</script>
<script src="/assets/js/firebase-auth.js" type="module"></script>
  <script src="/assets/js/service-worker-reg.js"></script>
</body>
</html>
