<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Morrow Industries — Business Ledger</title>


  <!-- Fonts -->
  <link
    href="https://fonts.googleapis.com/css2?family=Cinzel:wght@500;700&family=helvetica:wght@300;400;600&display=swap"
    rel="stylesheet">

  <!-- Firebase -->
  <script type="module" src="/assets/js/firebase-init.js"></script>

  <!-- jsPDF -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

  <style>
    :root {
      --gold: #d4af37;
      --glass: rgba(255, 255, 255, .008);
      --border: rgba(255, 255, 255, .15);
      --text: #f5f5f5;
      --muted: #9b9b9b;
    }

    * {
      box-sizing: border-box;
      font-family: helvetica, sans-serif;
    }

    body {
      margin: 0;
      background: #000;
      color: var(--text);
      padding: 16px;
    }

    h1 {
      font-family: Cinzel, serif;
      margin-bottom: 4px;
    }

    .subtitle {
      color: var(--muted);
      font-size: .85rem;
      margin-bottom: 16px;
    }

    /* Cards */
    .card {
      background: rgba(255, 255, 255, .024);
      border: 1px solid var(--border);
      border-radius: 5px;
      padding: 16px;
      backdrop-filter: blur(16px);
    }

    /* Ledger */
    .ledger {
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .entry {
      display: flex;
      justify-content: space-between;
      gap: 12px;
      padding: 12px;
      border-radius: 0px;
      background: rgba(255, 255, 255, 0);
      /* border-left:2px solid var(--border); */
    }

    .entry+.entry {
      border-top: 1px solid rgba(255, 255, 255, 0.03);
    }


    .entry .meta {
      font-size: .75rem;
      color: var(--muted);
    }

    .amount {
      font-weight: 600;
      color: var(--gold);
      white-space: nowrap;
    }

    .empty {
      text-align: center;
      padding: 40px 10px;
      color: var(--muted);
      font-size: .9rem;
    }

    /* Floating Add Button */
    .fab {
      position: fixed;
      bottom: 22px;
      right: 22px;
      width: 58px;
      height: 58px;
      border-radius: 50%;
      background: linear-gradient(135deg, #f0d36a, var(--gold));
      color: #000;
      font-size: 32px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pohelvetica;
      box-shadow: 0 10px 30px rgba(0, 0, 0, .4);
    }

    /* Modal */
    .modal {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, .6);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 100;
    }

    .modal.active {
      display: flex;
    }

    .modal-card {
      width: 100%;
      max-width: 420px;
      background: var(--glass);
      border: 1px solid var(--border);
      border-radius: 18px;
      padding: 18px;
      backdrop-filter: blur(20px);
    }

    label {
      font-size: .8rem;
      color: var(--muted);
      margin-top: 10px;
      display: block;
    }

    input,
    select {
      width: 100%;
      padding: 12px;
      margin-top: 4px;
      border-radius: 12px;
      border: 1px solid var(--border);
      background: rgba(0, 0, 0, .4);
      color: var(--text);
    }

    button {
      width: 100%;
      margin-top: 14px;
      padding: 14px;
      border-radius: 14px;
      border: none;
      background: linear-gradient(135deg, #f0d36a, var(--gold));
      font-weight: 600;
      cursor: pohelvetica;
    }

    .totals {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 16px;
      margin-bottom: 18px;
      padding-bottom: 12px;
      border-bottom: 1px solid rgba(255, 255, 255, 0.03);
    }

    .total-item span {
      font-size: 0.75rem;
      color: #9b9b9b;
    }

    .total-item strong {
      font-size: 1rem;
      font-weight: 600;
    }

    .total-item.net strong {
      color: var(--gold);
    }

    .export-controls {
      display: flex;
      gap: 25px;
      margin-top: 12px;
      margin-bottom: 12px;
    }

    .export-controls select {
      flex: 1;
      color: #fff;
      border: 1px solid rgba(255, 255, 255, 0.08);
      border-radius: 5px;
      padding: 8px;
      width: 75%;
      overflow: hidden;
    }

    .export-btn {
      background: transparent;
      border: 1px solid rgba(212, 175, 55, 0);
      color: var(--gold);
      padding: 10px;
      width: 25%;
      border-radius: 5px;
      font-size: 1.0rem;
    }

    /* Desktop */
    @media(min-width:1024px) {
      body {
        padding: 32px;
        max-width: 1100px;
        margin: auto;
      }
    }
  </style>
</head>

<body>

  <h1>Business Ledger</h1>
  <div class="subtitle">Permanent income & expense record</div>
  <div class="totals">
    <div class="total-item">
      <span>Total Income</span>
      <strong id="totalIncome">$0.00</strong>
    </div>
    <div class="total-item">
      <span>Total Expenses</span>
      <strong id="totalExpenses">$0.00</strong>
    </div>
    <div class="total-item net">
      <span>Net</span>
      <strong id="totalNet">$0.00</strong>
    </div>
  </div>

  <div class="export-controls">
    <select id="exportMonths" multiple>
      <!-- populated dynamically -->
    </select>

    <button id="exportPdf" class="export-btn">Export Statement</button>
  </div>

  <div class="card">
    <div id="ledger" class="ledger"></div>
    <div id="emptyState" class="empty">No ledger entries yet.</div>
  </div>

  <!-- Floating Add -->
  <div class="fab" id="openModal">+</div>

  <!-- Add Modal -->
  <div class="modal" id="modal">
    <div class="modal-card">
      <h3 style="font-family:Cinzel;margin-top:0;">Add Record</h3>

      <label>Type</label>
      <select id="type">
        <option value="expense">Expense</option>
        <option value="income">Income</option>
      </select>

      <label>Name / Description</label>
      <input id="name">

      <label>Amount</label>
      <input id="amount" type="number" step="0.01">

      <label>Date Paid / Collected</label>
      <input id="date" type="date">

      <button id="addBtn">Add Record</button>
    </div>
  </div>
  <script type="module">
    import { auth, db } from "/assets/js/firebase-init.js";
    import { onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
    import {
      collection, addDoc, serverTimestamp,
      onSnapshot, query, orderBy,
      doc, getDoc
    } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

    const ledgerEl = document.getElementById("ledger");
    const emptyEl = document.getElementById("emptyState");
    const modal = document.getElementById("modal");

    const nameInput = document.getElementById("name");
    const amountInput = document.getElementById("amount");
    const typeInput = document.getElementById("type");
    const dateInput = document.getElementById("date");

    const totalIncomeEl = document.getElementById("totalIncome");
    const totalExpensesEl = document.getElementById("totalExpenses");
    const totalNetEl = document.getElementById("totalNet");
    const exportMonthsEl = document.getElementById("exportMonths");
    const exportBtn = document.getElementById("exportPdf");

    const rendered = new Set();

    let totalIncome = 0;
    let totalExpenses = 0;

    // monthKey => { label, entries[] }
    const monthBuckets = {};

    openModal.onclick = () => modal.classList.add("active");
    modal.onclick = e => { if (e.target === modal) modal.classList.remove("active"); };

    onAuthStateChanged(auth, async user => {
      if (!user) return location.href = "/login.html";

      const snap = await getDoc(doc(db, "users", user.uid));
      if (!snap.exists() || !snap.data().isAdmin) {
        document.body.innerHTML = "<h2>Access Denied</h2>";
        return;
      }

      const ref = collection(db, "businessLedger");
      const q = query(
        ref,
        orderBy("date", "desc"),
        orderBy("createdAt", "desc")
      );


      onSnapshot(q, snap => {
        if (snap.size === 0) emptyEl.style.display = "block";

        snap.docChanges().forEach(c => {
          if (c.type !== "added" || rendered.has(c.doc.id)) return;
          rendered.add(c.doc.id);
          emptyEl.style.display = "none";

          const d = c.doc.data();
          processLedgerEntry(d);

          const dt = d.date.toDate();

          ledgerEl.innerHTML += `
          <div class="entry">
            <div>
              <div>${d.name}</div>
              <div class="meta">${dt.toLocaleDateString()} • ${d.addedByName}</div>
            </div>
            <div class="amount">${d.type === "expense" ? "-" : "+"}$${d.amount.toFixed(2)}</div>
          </div>`;
        });
      });

      addBtn.onclick = async () => {
        const name = nameInput.value.trim();
        const amount = parseFloat(amountInput.value);
        const date = dateInput.value;

        const [year, month, day] = dateInput.value.split("-").map(Number);
        if (!name || isNaN(amount) || !date) return alert("All fields required");

        await addDoc(ref, {
          name,
          amount,
          type: typeInput.value,
          date: new Date(year, month - 1, day, 12, 0, 0),
          addedByUid: user.uid,
          addedByName: user.displayName || user.email,
          createdAt: serverTimestamp()
        });

        nameInput.value = "";
        amountInput.value = "";
        modal.classList.remove("active");
      };
    });

    function processLedgerEntry(entry) {
      const amount = entry.amount;

      if (entry.type === "income") totalIncome += amount;
      else totalExpenses += amount;

      totalIncomeEl.textContent = `$${totalIncome.toFixed(2)}`;
      totalExpensesEl.textContent = `$${totalExpenses.toFixed(2)}`;
      totalNetEl.textContent = `$${(totalIncome - totalExpenses).toFixed(2)}`;

      const date = entry.date.toDate();
      const monthKey = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, "0")}`;
      const label = date.toLocaleString("default", { month: "long", year: "numeric" });

      if (!monthBuckets[monthKey]) {
        monthBuckets[monthKey] = { label, entries: [] };

        const opt = document.createElement("option");
        opt.value = monthKey;
        opt.textContent = label;
        exportMonthsEl.appendChild(opt);
      }

      monthBuckets[monthKey].entries.push(entry);
    }

    exportBtn.onclick = async () => {
      const selected = Array.from(exportMonthsEl.selectedOptions).map(o => o.value);
      if (selected.length === 0) {
        alert("Select at least one month to export.");
        return;
      }

      const { jsPDF } = window.jspdf;
      const doc = new jsPDF("p", "pt", "a4");

      const pageWidth =
        doc.internal.pageSize.getWidth?.() ||
        doc.internal.pageSize.width;

      const pageHeight =
        doc.internal.pageSize.getHeight?.() ||
        doc.internal.pageSize.height;


      const marginX = 40;
      let y = 40;

      let totalIncome = 0;
      let totalExpenses = 0;

      // ===== HEADER =====
      const logo = new Image();
      logo.src = "/assets/logo/morrow-logo.png";

      await new Promise(r => logo.onload = r);

      // Logo sizing (aspect-safe)
      const logoWidth = 90;
      const logoHeight = logoWidth * (logo.naturalHeight / logo.naturalWidth);

      // Top margin baseline
      const headerTop = 40;

      // Draw logo
      doc.addImage(
        logo,
        "PNG",
        marginX,
        headerTop,
        logoWidth,
        logoHeight
      );

      // Vertical divider (centered to logo)
      const dividerX = marginX + logoWidth + 16;
      doc.setLineWidth(1);
      doc.line(
        dividerX,
        headerTop - 4,
        dividerX,
        headerTop + logoHeight + 4
      );

      // Company name — vertically aligned to logo center
      doc.setFont("helvetica", "bold");
      doc.setFontSize(18);
      doc.text(
        "Morrow Industries",
        dividerX + 16,
        headerTop + logoHeight / 2 + 6
      );

      // Move cursor below header
      y = headerTop + logoHeight + 26;

      // Statement title (restored)
      doc.setFontSize(14);
      doc.setFont("helvetica", "normal");
      doc.text(
        "Business Ledger Statement",
        marginX,
        y
      );

      y += 18;

      // Optional generated date (clean + subtle)
      doc.setFontSize(9);
      doc.text(
        `Generated ${new Date().toLocaleDateString()}`,
        marginX,
        y
      );

      y += 20;



      // ---------- TABLE HEADER ----------
      function drawTableHeader() {
        doc.setFontSize(10);
        doc.setFont("helvetica", "bold");
        doc.text("Date", marginX, y);
        doc.text("Description", marginX + 80, y);
        doc.text("Added By", marginX + 300, y);
        doc.text("Amount", pageWidth - marginX - 60, y, { align: "right" });

        y += 10;
        doc.setLineWidth(0.5);
        doc.line(marginX, y, pageWidth - marginX, y);
        y += 12;
        doc.setFont("helvetica", "normal");
      }

      drawTableHeader();

      // ---------- TABLE ROWS ----------
      for (const key of selected) {
        const bucket = monthBuckets[key];
        if (!bucket) continue;

        doc.setFont("helvetica", "bold");
        doc.text(bucket.label, marginX, y);
        y += 16;
        doc.setFont("helvetica", "normal");

        for (const e of bucket.entries) {
          if (y > pageHeight - 100) {
            doc.addPage();
            y = 40;
            drawTableHeader();
          }

          const dateStr = e.date.toDate().toLocaleDateString();
          const sign = e.type === "income" ? "+" : "-";

          if (e.type === "income") totalIncome += e.amount;
          else totalExpenses += e.amount;

          doc.text(dateStr, marginX, y);
          doc.text(e.name, marginX + 80, y, { maxWidth: 200 });
          doc.text(e.addedByName, marginX + 300, y, { maxWidth: 150 });
          doc.text(
            `${sign}$${e.amount.toFixed(2)}`,
            pageWidth - marginX - 60,
            y,
            { align: "right" }
          );

          y += 14;
        }

        y += 10;
      }

      // ---------- TOTALS ----------
      if (y > pageHeight - 120) {
        doc.addPage();
        y = 40;
      }

      doc.setFont("helvetica", "bold");
      doc.text(`Total Income: $${totalIncome.toFixed(2)}`, marginX, y);
      y += 14;
      doc.text(`Total Expenses: $${totalExpenses.toFixed(2)}`, marginX, y);
      y += 14;
      doc.text(`Net: $${(totalIncome - totalExpenses).toFixed(2)}`, marginX, y);
      doc.setFont("helvetica", "normal");

      // ---------- CERTIFICATION (FINAL PAGE ONLY) ----------
      doc.addPage();
      y = 60;

      doc.setFont("helvetica", "bold");
      doc.setFontSize(13);
      doc.text("Certification of Accuracy", marginX, y);
      y += 20;

      doc.setFont("helvetica", "normal");
      doc.setFontSize(11);
      doc.text(
        "I certify that the information contained in this statement has been reviewed and is accurate and complete to the best of my knowledge. This statement is prepared for helveticanal record-keeping and financial reporting purposes.",
        marginX,
        y,
        { maxWidth: pageWidth - marginX * 2 }
      );

      y += 80;

      doc.line(marginX, y, marginX + 220, y);
      doc.text("Authorized Signature", marginX, y + 14);

      doc.line(pageWidth - marginX - 220, y, pageWidth - marginX, y);
      doc.text("Date", pageWidth - marginX - 220, y + 14);

      y += 40;
      doc.text("Printed Name: Randal Morrow — Owner", marginX, y);

      // ---------- FOOTERS + PAGE NUMBERS ----------
      const totalPages =
        typeof doc.getNumberOfPages === "function"
          ? doc.getNumberOfPages()
          : doc.internal.pages.length - 1;


      for (let i = 1; i <= totalPages; i++) {
        doc.setPage(i);
        doc.setFontSize(9);
        doc.text(
          `Page ${i} of ${totalPages}`,
          pageWidth / 2,
          pageHeight - 50,
          { align: "center" }
        );
        doc.text(
          "Morrow Industries — Internal Record",
          pageWidth / 2,
          pageHeight - 38,
          { align: "center" }
        );
        doc.text(
          "© 2025 Morrow Industries LLC",
          pageWidth / 2,
          pageHeight - 28,
          { align: "center" }
        );

      }

      // ---------- SAVE ----------
      doc.save("Business Ledger Statement.pdf");
    };

  </script>


</body>

</html>