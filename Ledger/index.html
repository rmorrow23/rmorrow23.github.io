<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Morrow Industries ‚Äî Business Ledger</title>

  <!-- Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@500;700&family=Inter:wght@300;400;600&display=swap" rel="stylesheet">

  <!-- Firebase -->
  <script type="module" src="/js/firebase-init.js"></script>

  <style>
    :root {
      --gold:#d4af37;
      --glass:rgba(255,255,255,0.08);
      --border:rgba(255,255,255,0.15);
      --text:#f5f5f5;
      --muted:#9b9b9b;
    }

    * { box-sizing:border-box; font-family:Inter,sans-serif; }

    body {
      margin:0;
      background:radial-gradient(circle at top,#111,#000);
      color:var(--text);
      padding:16px;
    }

    h1 {
      font-family:Cinzel,serif;
      font-size:1.8rem;
      margin-bottom:6px;
    }

    .subtitle {
      font-size:.85rem;
      color:var(--muted);
      margin-bottom:18px;
    }

    .card {
      background:var(--glass);
      border:1px solid var(--border);
      border-radius:18px;
      padding:16px;
      backdrop-filter:blur(16px);
    }

    label { font-size:.8rem; color:var(--muted); margin-top:10px; display:block; }
    input,select {
      width:100%;
      padding:12px;
      margin-top:4px;
      border-radius:12px;
      border:1px solid var(--border);
      background:rgba(0,0,0,.4);
      color:var(--text);
    }

    input[type="date"] { color-scheme:dark; }

    button {
      width:100%;
      margin-top:14px;
      padding:14px;
      border-radius:14px;
      border:none;
      background:linear-gradient(135deg,#f0d36a,var(--gold));
      font-weight:600;
      cursor:pointer;
    }

    .ledger { display:flex; flex-direction:column; gap:10px; }

    .entry {
      display:flex;
      justify-content:space-between;
      gap:12px;
      padding:12px;
      border-radius:14px;
      background:rgba(255,255,255,.04);
      border:1px solid var(--border);
    }

    .entry .meta { font-size:.75rem; color:var(--muted); }
    .amount { font-weight:600; color:var(--gold); }

    .month {
      padding:12px;
      border-radius:14px;
      border:1px solid var(--border);
      background:rgba(255,255,255,.04);
      margin-bottom:10px;
    }

    /* Desktop layout */
    @media (min-width:1024px) {
      .desktop-grid {
        display:grid;
        grid-template-columns:320px 320px 1fr;
        gap:24px;
      }

      .entry-card,
      .monthly-card {
        position:sticky;
        top:24px;
      }

      .ledger-card {
        max-height:calc(100vh - 64px);
        overflow-y:auto;
      }
    }
  </style>
</head>

<body>

<h1>Business Ledger</h1>
<div class="subtitle">Permanent income & expense record</div>

<div class="desktop-grid">

  <!-- ADD -->
  <div class="card entry-card">
    <label>Type</label>
    <select id="type">
      <option value="expense">Expense</option>
      <option value="income">Income</option>
    </select>

    <label>Name</label>
    <input id="name">

    <label>Amount</label>
    <input id="amount" type="number" step="0.01">

    <label>Date</label>
    <input id="date" type="date">

    <button id="addBtn">Add Record</button>
  </div>

  <!-- MONTHLY -->
  <div class="card monthly-card">
    <h3 style="font-family:Cinzel;">Monthly Breakdown</h3>
    <div id="monthly"></div>
    <button id="exportPdf">Export PDF</button>
  </div>

  <!-- LEDGER -->
  <div class="card ledger-card">
    <div class="ledger" id="ledger"></div>
  </div>

</div>

<script type="module">
  import { auth, db } from "/js/firebase-init.js";
  import { onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
  import {
    collection, addDoc, serverTimestamp,
    onSnapshot, query, orderBy,
    doc, getDoc
  } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

  const ledgerEl = document.getElementById("ledger");
  const monthlyEl = document.getElementById("monthly");
  const rendered = new Set();
  const monthly = {};

  function renderMonthly() {
    monthlyEl.innerHTML = "";
    Object.keys(monthly).sort().reverse().forEach(m=>{
      const d = monthly[m];
      monthlyEl.innerHTML += `
        <div class="month">
          <div>${m}</div>
          <div>Income: $${d.income.toFixed(2)}</div>
          <div>Expenses: $${d.expense.toFixed(2)}</div>
          <div style="color:var(--gold)">Net: $${(d.income-d.expense).toFixed(2)}</div>
        </div>`;
    });
  }

  onAuthStateChanged(auth, async user => {
    if (!user) return location.href = "/login.html";

    // üîê ADMIN CHECK
    const userSnap = await getDoc(doc(db,"users",user.uid));
    if (!userSnap.exists() || !userSnap.data().isAdmin) {
      document.body.innerHTML = "<h2>Access Denied</h2>";
      return;
    }

    const ref = collection(db,"businessLedger");
    const q = query(ref, orderBy("date","desc"));

    onSnapshot(q, snap=>{
      snap.docChanges().forEach(c=>{
        if (c.type!=="added" || rendered.has(c.doc.id)) return;
        rendered.add(c.doc.id);

        const d=c.doc.data();
        const dt=d.date.toDate();
        const key=`${dt.getFullYear()}-${String(dt.getMonth()+1).padStart(2,"0")}`;

        if(!monthly[key]) monthly[key]={income:0,expense:0};
        d.type==="income" ? monthly[key].income+=d.amount : monthly[key].expense+=d.amount;

        ledgerEl.innerHTML+=`
          <div class="entry">
            <div>
              <div>${d.name}</div>
              <div class="meta">${dt.toLocaleDateString()} ‚Ä¢ ${d.addedByName}</div>
            </div>
            <div class="amount">${d.type==="expense"?"-":"+"}$${d.amount.toFixed(2)}</div>
          </div>`;

        renderMonthly();
      });
    });

    addBtn.onclick = async ()=>{
      if(!name.value||!amount.value||!date.value) return alert("All fields required");
      await addDoc(ref,{
        name:name.value,
        amount:parseFloat(amount.value),
        type:type.value,
        date:new Date(date.value),
        addedByUid:user.uid,
        addedByName:user.displayName||user.email,
        createdAt:serverTimestamp()
      });
      name.value=""; amount.value="";
    };

    exportPdf.onclick=()=>{
      const w=window.open("","_blank");
      w.document.write(`<h1>Morrow Industries ‚Äî Ledger</h1><script>window.print()<\/script>`);
      w.document.close();
    };
  });
</script>

</body>
</html>