<!DOCTYPE html>
<html lang="en" class="light">
<head>
    <meta charset="utf-8"/>
    <meta content="width=device-width, initial-scale=1.0" name="viewport"/>
    <title>Shopping List Manager</title>
    <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-storage-compat.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Work+Sans:wght@300;400;500;600;700&display=swap" rel="stylesheet"/>
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght,FILL@100..700,0..1&display=swap" rel="stylesheet"/>
    <script id="tailwind-config">
        tailwind.config = {
            darkMode: "class",
            theme: {
                extend: {
                    colors: {
                        "primary": "#13ec37",
                        "background-light": "#f8faf8",
                        "background-dark": "#0a120b",
                    },
                    fontFamily: { "display": ["Work Sans", "sans-serif"] }
                },
            },
        }
    </script>
    <style>
        ::-webkit-scrollbar { display: none; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        @media (min-width: 1024px) {
            .desktop-grid { display: grid; grid-template-columns: 280px 1fr; }
        }
    </style>
</head>
<body class="bg-background-light dark:bg-background-dark font-display text-slate-900 dark:text-slate-100 transition-colors duration-300">
    
    <div class="desktop-grid min-h-screen">
        <aside class="hidden lg:flex flex-col border-r border-slate-200 dark:border-slate-800 bg-white dark:bg-slate-950 p-6 sticky top-0 h-screen">
            <h1 class="text-xl font-black text-primary mb-10 tracking-tighter italic">GOURMET MANAGER</h1>
            <nav class="space-y-2 flex-1">
                <button onclick="showTab('list')" class="nav-btn w-full flex items-center gap-3 p-3 rounded-xl text-primary bg-primary/10 font-bold" data-tab="list">
                    <span class="material-symbols-outlined">format_list_bulleted</span> Shopping List
                </button>
                <button onclick="showTab('recipes')" class="nav-btn w-full flex items-center gap-3 p-3 rounded-xl text-slate-400 hover:bg-slate-50 dark:hover:bg-slate-900 font-bold" data-tab="recipes">
                    <span class="material-symbols-outlined">restaurant</span> Recipes
                </button>
                <button onclick="showTab('stats')" class="nav-btn w-full flex items-center gap-3 p-3 rounded-xl text-slate-400 hover:bg-slate-50 dark:hover:bg-slate-900 font-bold" data-tab="stats">
                    <span class="material-symbols-outlined">analytics</span> Statistics
                </button>
            </nav>
            <button onclick="toggleTheme()" class="mt-auto flex items-center gap-3 p-3 text-slate-400 font-bold">
                <span id="themeIconDesktop" class="material-symbols-outlined">dark_mode</span> Appearance
            </button>
        </aside>

        <div class="relative flex flex-col h-screen overflow-hidden">
            <header class="p-6 lg:px-10 flex justify-between items-center bg-background-light/80 dark:bg-background-dark/80 backdrop-blur-md z-20">
                <div>
                    <span class="text-[10px] font-black uppercase text-[#4c9a59] tracking-[0.2em]">Shopping List Manager</span>
                    <div class="flex items-center gap-3">
                        <select id="listSelector" onchange="switchList()" class="bg-transparent border-none p-0 text-2xl font-bold focus:ring-0 dark:text-white cursor-pointer"></select>
                        <button onclick="shareList()" class="text-slate-400 hover:text-primary"><span class="material-symbols-outlined">share</span></button>
                    </div>
                </div>
                <button onclick="createNewList()" class="px-5 py-2 bg-primary text-black font-black text-[10px] uppercase rounded-full shadow-lg">
                    + New List
                </button>
            </header>

            <main class="flex-1 overflow-y-auto px-6 lg:px-10 pb-64">
                <div id="tab-list" class="tab-content active space-y-6 max-w-4xl">
                    <div id="shoppingItemsContainer" class="space-y-6"></div>
                </div>
                <div id="tab-recipes" class="tab-content space-y-6">
                    <div class="flex flex-col md:flex-row justify-between items-start md:items-center gap-4">
                        <h2 class="text-2xl font-bold">Cookbook</h2>
                        <div class="flex gap-2 w-full md:w-auto">
                             <input id="recipeSearch" type="text" placeholder="Search web..." class="flex-1 md:w-64 rounded-full border-none bg-slate-100 dark:bg-slate-800 text-sm px-4 focus:ring-primary">
                             <button onclick="discoverRecipes()" class="bg-primary text-black p-2 rounded-full flex items-center"><span class="material-symbols-outlined">search</span></button>
                             <button onclick="openRecipeModal()" class="bg-slate-100 dark:bg-slate-800 text-slate-500 p-2 rounded-full flex items-center"><span class="material-symbols-outlined">add</span></button>
                        </div>
                    </div>
                    <div id="recipeContainer" class="grid grid-cols-1 sm:grid-cols-2 xl:grid-cols-3 gap-6"></div>
                </div>
                <div id="tab-stats" class="tab-content pt-10">
                    <div class="max-w-xl mx-auto bg-white dark:bg-slate-900 p-10 rounded-[2.5rem] text-center shadow-xl border border-slate-100 dark:border-slate-800">
                        <h3 class="text-slate-400 text-xs font-black uppercase tracking-widest mb-4">Current Subtotal</h3>
                        <p id="statsTotal" class="text-6xl font-black text-primary">$0.00</p>
                    </div>
                </div>
            </main>

            <div id="floatingInput" class="absolute bottom-24 lg:bottom-10 left-0 right-0 px-6 z-30">
                <div class="max-w-3xl mx-auto bg-white dark:bg-slate-900 p-4 rounded-[2rem] shadow-2xl border border-slate-100 dark:border-slate-800">
                    <div class="flex flex-col gap-3">
                        <div class="flex gap-2">
                            <input id="itemName" class="flex-1 bg-slate-50 dark:bg-slate-800 border-none rounded-xl p-3 text-sm" placeholder="Item Name..."/>
                            <select id="itemCategory" class="w-28 bg-slate-50 dark:bg-slate-800 border-none rounded-xl text-[10px] font-bold uppercase text-slate-500">
                                <option value="General">General</option>
                                <option value="Produce">Produce</option>
                                <option value="Dairy">Dairy</option>
                                <option value="Meat">Meat</option>
                                <option value="Frozen">Frozen</option>
                                <option value="Pantry">Pantry</option>
                            </select>
                        </div>
                        <div class="flex gap-2 items-center">
                            <input id="itemQty" type="number" value="1" class="w-full bg-slate-50 dark:bg-slate-800 border-none rounded-xl text-sm text-center p-3"/>
                            <input id="itemPrice" type="number" step="0.01" class="w-full bg-slate-50 dark:bg-slate-800 border-none rounded-xl text-sm text-center p-3" placeholder="$ Price"/>
                            <button onclick="addItem()" class="w-full bg-primary text-black font-black uppercase text-xs tracking-widest py-3 rounded-xl">Add to List</button>
                        </div>
                    </div>
                </div>
            </div>

            <nav class="lg:hidden flex justify-around items-center bg-white/90 dark:bg-slate-950/90 backdrop-blur-xl h-20 border-t border-slate-100 dark:border-slate-800 fixed bottom-0 left-0 right-0 z-40">
                <button onclick="showTab('list')" class="nav-btn-mobile text-primary" data-tab="list"><span class="material-symbols-outlined">format_list_bulleted</span></button>
                <button onclick="showTab('recipes')" class="nav-btn-mobile text-slate-400" data-tab="recipes"><span class="material-symbols-outlined">restaurant</span></button>
                <button onclick="showTab('stats')" class="nav-btn-mobile text-slate-400" data-tab="stats"><span class="material-symbols-outlined">analytics</span></button>
                <button onclick="toggleTheme()" class="text-slate-400"><span class="material-symbols-outlined">dark_mode</span></button>
            </nav>
        </div>
    </div>

    <div id="recipeModal" class="hidden fixed inset-0 z-50 bg-black/60 backdrop-blur-sm flex items-center justify-center p-4">
        <div class="bg-white dark:bg-slate-900 w-full max-w-md rounded-[2.5rem] p-8 space-y-4">
            <h4 class="font-bold text-xl">New Recipe</h4>
            <input id="recTitle" type="text" placeholder="Title" class="w-full rounded-xl border-none bg-slate-100 dark:bg-slate-800 p-3">
            <textarea id="recIngreds" placeholder="Ingredients (One per line)" class="w-full rounded-xl border-none bg-slate-100 dark:bg-slate-800 h-32 p-3"></textarea>
            <div class="flex gap-2 pt-4">
                <button onclick="closeRecipeModal()" class="flex-1 py-3 text-slate-400 font-bold uppercase text-[10px]">Cancel</button>
                <button onclick="saveManualRecipe()" class="flex-1 py-3 bg-primary text-black font-black rounded-xl uppercase text-[10px]">Save Recipe</button>
            </div>
        </div>
    </div>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyAyWD_KLFAVDOFW7FyHPHYGG1gge2go2AY",
            authDomain: "morrow-industries.firebaseapp.com",
            projectId: "morrow-industries",
            storageBucket: "morrow-industries.appspot.com",
            messagingSenderId: "75190213345",
            appId: "1:75190213345:web:a521b54a1c8e00b68d75a0"
        };

        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        let state = { currentListId: 'Groceries', lists: {}, recipes: [] };

        // --- Core Fix: Deep Clone Helper ---
        function getCleanList() {
            return JSON.parse(JSON.stringify(state.lists[state.currentListId] || { items: [] }));
        }

        async function toggleItem(id) {
            const current = getCleanList();
            const item = current.items.find(i => i.id === id);
            if (item) {
                item.completed = !item.completed;
                await db.collection("shoppingLists").doc(state.currentListId).set(current);
            }
        }

        async function editItemValue(id) {
            const current = getCleanList();
            const item = current.items.find(i => i.id === id);
            if (!item) return;

            const nName = prompt("Edit Name:", item.name);
            if (nName === null) return;
            const nPrice = prompt("Edit Price:", item.price);
            const nQty = prompt("Edit Qty:", item.qty);

            item.name = nName || item.name;
            item.price = parseFloat(nPrice) || 0;
            item.qty = parseInt(nQty) || 1;

            await db.collection("shoppingLists").doc(state.currentListId).set(current);
        }

        async function addItem() {
            const name = document.getElementById('itemName').value;
            const price = parseFloat(document.getElementById('itemPrice').value) || 0;
            const qty = parseInt(document.getElementById('itemQty').value) || 1;
            const cat = document.getElementById('itemCategory').value;
            if (name) {
                const current = getCleanList();
                current.items.push({ name, qty, price, category: cat, completed: false, id: Date.now() });
                await db.collection("shoppingLists").doc(state.currentListId).set(current);
                document.getElementById('itemName').value = '';
                document.getElementById('itemPrice').value = '';
            }
        }

        async function deleteItem(id) {
            if(!confirm("Delete?")) return;
            const current = getCleanList();
            current.items = current.items.filter(i => i.id !== id);
            await db.collection("shoppingLists").doc(state.currentListId).set(current);
        }

        // --- Render Logic ---
        function render() {
            const current = state.lists[state.currentListId] || { items: [] };
            const sel = document.getElementById('listSelector');
            sel.innerHTML = Object.keys(state.lists).map(id => `<option value="${id}" ${id === state.currentListId ? 'selected' : ''}>${id}</option>`).join('');

            const cont = document.getElementById('shoppingItemsContainer');
            cont.innerHTML = '';
            const groups = (current.items || []).reduce((acc, i) => { (acc[i.category] = acc[i.category] || []).push(i); return acc; }, {});
            
            Object.keys(groups).sort().forEach(cat => {
                let itemsHtml = groups[cat].map(i => `
                    <div class="bg-white dark:bg-slate-900 p-4 rounded-2xl border dark:border-slate-800 flex justify-between items-center shadow-sm ${i.completed ? 'opacity-30' : ''}">
                        <div class="flex items-center gap-4 flex-1">
                            <input type="checkbox" ${i.completed ? 'checked' : ''} onchange="toggleItem(${i.id})" class="h-5 w-5 rounded border-primary text-primary focus:ring-0 cursor-pointer">
                            <div onclick="editItemValue(${i.id})" class="cursor-pointer flex-1">
                                <p class="font-bold text-sm ${i.completed ? 'line-through decoration-primary' : ''}">${i.name}</p>
                                <p class="text-[10px] text-slate-400 font-bold uppercase">QTY: ${i.qty} â€¢ $${(i.price * i.qty).toFixed(2)}</p>
                            </div>
                        </div>
                        <button onclick="deleteItem(${i.id})" class="text-slate-300 hover:text-red-500 ml-4"><span class="material-symbols-outlined text-lg">delete</span></button>
                    </div>
                `).join('');

                cont.innerHTML += `<div class="pt-2"><h4 class="text-[10px] font-black text-primary uppercase tracking-widest mb-4 ml-2">${cat}</h4><div class="space-y-3">${itemsHtml}</div></div>`;
            });

            const total = (current.items || []).reduce((s, i) => s + (i.qty * i.price), 0);
            document.getElementById('statsTotal').innerText = `$${total.toFixed(2)}`;
        }

        // --- Theme/Tabs/Init (Standard) ---
        function showTab(tabId) {
            document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
            document.getElementById(`tab-${tabId}`).classList.add('active');
            document.querySelectorAll('.nav-btn').forEach(btn => btn.classList.remove('text-primary', 'bg-primary/10'));
            const activeSidebar = document.querySelector(`.nav-btn[data-tab="${tabId}"]`);
            if(activeSidebar) activeSidebar.classList.add('text-primary', 'bg-primary/10');
            document.getElementById('floatingInput').style.display = (tabId === 'list') ? 'block' : 'none';
        }

        function switchList() { state.currentListId = document.getElementById('listSelector').value; render(); }
        async function createNewList() { const n = prompt("Name:"); if(n) { await db.collection("shoppingLists").doc(n).set({ items: [] }); state.currentListId = n; } }
        function toggleTheme() { document.documentElement.classList.toggle('dark'); }
        function shareList() { navigator.clipboard.writeText(window.location.href + "?list=" + state.currentListId); alert("Link Copied!"); }

        window.onload = () => {
            const urlParams = new URLSearchParams(window.location.search);
            if(urlParams.get('list')) state.currentListId = urlParams.get('list');
            db.collection("shoppingLists").onSnapshot(s => { s.forEach(doc => state.lists[doc.id] = doc.data()); render(); });
        };
    </script>
</body>
</html>
